<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador de comidas</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            header: {
              DEFAULT: '#4a4a4a'
            }
          },
          boxShadow: {
            'elev': '0 10px 20px rgba(0,0,0,0.12), 0 6px 6px rgba(0,0,0,0.08)'
          },
          borderRadius: {
            'xl2': '1rem'
          },
          keyframes: {
            'modal-in': { '0%': { opacity: 0, transform: 'translateY(10px) scale(0.98)' }, '100%': { opacity: 1, transform: 'translateY(0) scale(1)' } },
            'modal-out': { '0%': { opacity: 1, transform: 'translateY(0) scale(1)' }, '100%': { opacity: 0, transform: 'translateY(10px) scale(0.98)' } }
          },
          animation: {
            'modal-in': 'modal-in 180ms ease-out',
            'modal-out': 'modal-out 150ms ease-in'
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --accent: #4a4a4a; /* Color cabecera editable */
    }
    .accent-bg { background-color: var(--accent); }
    .accent-text { color: #f0f0f0; }
    .accent-dark { background-color: color-mix(in srgb, var(--accent) 80%, black); }
    .fade-enter { animation: modal-in 180ms ease-out; }
    .fade-leave { animation: modal-out 150ms ease-in forwards; }
    .backdrop {
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #c3c3c3; border-radius: 8px; }
    .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #555; }
    .btn {
      @apply px-3 py-2 rounded-lg font-medium shadow-sm;
    }
    .btn-primary { @apply text-white bg-blue-600 hover:bg-blue-700 active:bg-blue-800; }
    .btn-ghost { @apply bg-transparent hover:bg-black/5 dark:hover:bg-white/5; }
    .btn-danger { @apply text-white bg-red-600 hover:bg-red-700 active:bg-red-800; }
    .btn-success { @apply text-white bg-green-600 hover:bg-green-700 active:bg-green-800; }
    .input {
      @apply w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-zinc-900 dark:border-zinc-700;
    }
    .chip {
      @apply inline-block text-xs px-2 py-1 rounded-full bg-black/5 dark:bg-white/10;
    }
    .nav-item { @apply flex flex-col items-center justify-center w-full py-2 gap-1 text-xs font-medium; }
    .nav-item.active { @apply text-blue-600 dark:text-blue-400; }
    .td-filled { background-color: #fff8cc; }
    .dark .td-filled { background-color: #3a3a24; }
  </style>
</head>
<body class="bg-zinc-100 text-zinc-900 dark:bg-zinc-950 dark:text-zinc-100 transition-colors">
  <!-- HEADER -->
  <header class="accent-dark text-white">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 id="tituloEditable" contenteditable="true" class="text-xl md:text-2xl font-bold px-2 py-1 rounded-md bg-white/10 outline-none" onblur="guardarTitulo()">Planificador de comidas</h1>
      <div class="text-xs opacity-90 select-none">Semana & Recetas</div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto p-4 pb-24">
    <!-- TABS -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
      <button class="btn btn-ghost border dark:border-zinc-800" data-tab="plan" onclick="showTab('plan')">üóìÔ∏è Planificaci√≥n</button>
      <button class="btn btn-ghost border dark:border-zinc-800" data-tab="recetas" onclick="showTab('recetas')">üç≤ Recetas</button>
      <button class="btn btn-ghost border dark:border-zinc-800" data-tab="chef" onclick="showTab('chef')">ü§ñ Chef (IA)</button>
      <button class="btn btn-ghost border dark:border-zinc-800" data-tab="ajustes" onclick="showTab('ajustes')">‚öôÔ∏è Ajustes</button>
    </div>

    <!-- PAGE: PLANIFICACI√ìN -->
    <section id="tab-plan" class="space-y-4">
      <!-- Semana controls -->
      <div class="flex items-center justify-center gap-3">
        <button class="btn btn-ghost border dark:border-zinc-800" onclick="cambiarSemana(-1)">‚¨ÖÔ∏è</button>
        <strong id="rangoSemana" class="px-3 py-2 rounded-lg bg-white dark:bg-zinc-900 border dark:border-zinc-800 select-none"></strong>
        <button class="btn btn-ghost border dark:border-zinc-800" onclick="cambiarSemana(1)">‚û°Ô∏è</button>
      </div>

      <!-- Tabla -->
      <div class="overflow-x-auto shadow-elev rounded-xl bg-white dark:bg-zinc-900 border dark:border-zinc-800">
        <table class="min-w-[800px] w-full text-sm">
          <thead>
            <tr class="text-white" style="background: var(--accent);">
              <th class="p-3 text-left">Franja/D√≠a</th>
              <th class="p-3">Lunes</th>
              <th class="p-3">Martes</th>
              <th class="p-3">Mi√©rcoles</th>
              <th class="p-3">Jueves</th>
              <th class="p-3">Viernes</th>
              <th class="p-3">S√°bado</th>
              <th class="p-3">Domingo</th>
            </tr>
          </thead>
          <tbody id="tbody" class="[&_td]:align-top [&_td]:p-3"></tbody>
        </table>
      </div>

      <!-- Botones bajo tabla -->
      <div class="flex flex-wrap items-center justify-center gap-2">
        <button id="btnListaCompra" class="btn btn-primary">Lista de la compra</button>
        <button class="btn btn-ghost" onclick="vaciarSemanaModal()">Vaciar semana</button>
      </div>
    </section>

    <!-- PAGE: RECETAS -->
    <section id="tab-recetas" class="hidden space-y-4">
      <div class="flex flex-col md:flex-row gap-3 justify-between">
        <div class="flex-1">
          <input id="buscadorRecetas" class="input" placeholder="Buscar recetas por nombre o ingrediente..." oninput="renderRecetas()" />
        </div>
        <div>
          <button class="btn btn-success" onclick="abrirModalNuevaReceta()">+ Nueva receta</button>
        </div>
      </div>

      <div id="listaRecetas" class="grid gap-3 md:grid-cols-2 lg:grid-cols-3"></div>
      <p id="sinRecetas" class="hidden text-sm opacity-70">No hay recetas todav√≠a. Crea tu primera con ‚Äú+ Nueva receta‚Äù.</p>
    </section>

    <!-- PAGE: CHEF -->
    <section id="tab-chef" class="hidden">
      <div class="rounded-xl p-6 shadow-elev bg-white dark:bg-zinc-900 border dark:border-zinc-800 text-center">
        <div class="text-5xl mb-3">‚ú®</div>
        <h2 class="text-xl font-bold mb-2">Chef IA ‚Äî Pr√≥ximamente</h2>
        <p class="opacity-80">Muy pronto podr√°s generar recetas, ideas de men√∫ y sugerencias con lo que tengas en la nevera.</p>
      </div>
    </section>

    <!-- PAGE: AJUSTES -->
    <section id="tab-ajustes" class="hidden space-y-4">
      <div class="rounded-xl p-6 shadow-elev bg-white dark:bg-zinc-900 border dark:border-zinc-800">
        <h3 class="text-lg font-semibold mb-4">Apariencia</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-1">Tema</label>
            <select id="temaSelect" class="input" onchange="cambiarTemaSelect(this.value)">
              <option value="system">Autom√°tico (seg√∫n sistema)</option>
              <option value="light">Claro</option>
              <option value="dark">Oscuro</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Color de cabecera</label>
            <input id="colorCabecera" type="color" class="input h-10 p-1" onchange="cambiarColorCabecera(this.value)" />
          </div>
          <div>
            <label class="block text-sm mb-1">T√≠tulo de la app</label>
            <input id="tituloInputMirror" class="input" placeholder="Planificador de comidas" oninput="syncTitulo(this.value)" />
          </div>
        </div>
      </div>

      <div class="rounded-xl p-6 shadow-elev bg-white dark:bg-zinc-900 border dark:border-zinc-800">
        <h3 class="text-lg font-semibold mb-4">Franjas a mostrar</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="flex items-center gap-2"><input type="checkbox" id="chkDesayuno" class="scale-125" /> Desayuno</label>
          <label class="flex items-center gap-2"><input type="checkbox" id="chkComida" class="scale-125" /> Comida</label>
          <label class="flex items-center gap-2"><input type="checkbox" id="chkCena" class="scale-125" /> Cena</label>
        </div>
      </div>

      <div class="rounded-xl p-6 shadow-elev bg-white dark:bg-zinc-900 border dark:border-zinc-800">
        <h3 class="text-lg font-semibold mb-4">Datos</h3>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-ghost" onclick="exportarDatos()">Exportar datos (.json)</button>
          <label class="btn btn-ghost cursor-pointer">
            Importar datos (.json)
            <input type="file" accept="application/json" class="hidden" onchange="importarDatos(this.files[0])" />
          </label>
          <button class="btn btn-danger" onclick="confirmarReset()">Restablecer todo</button>
        </div>
        <p class="text-xs opacity-70 mt-2">Se guardan en tu navegador (LocalStorage). Exporta antes de limpiar.</p>
      </div>
    </section>
  </main>

  <!-- BOTTOM NAV (sticky) -->
  <nav class="fixed bottom-0 left-0 right-0 border-t bg-white/90 dark:bg-zinc-900/90 backdrop-blur shadow z-40">
    <div class="max-w-5xl mx-auto grid grid-cols-4">
      <button class="nav-item active" onclick="showTab('plan')" id="nav-plan">üóìÔ∏è<span>Plan</span></button>
      <button class="nav-item" onclick="showTab('recetas')" id="nav-recetas">üç≤<span>Recetas</span></button>
      <button class="nav-item" onclick="showTab('chef')" id="nav-chef">ü§ñ<span>Chef</span></button>
      <button class="nav-item" onclick="showTab('ajustes')" id="nav-ajustes">‚öôÔ∏è<span>Ajustes</span></button>
    </div>
  </nav>

  <!-- ========== MODALES ========== -->

  <!-- Modal Editar Comida / Seleccionar Receta -->
  <div id="modalComida" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 backdrop fade-enter backdrop"></div>
    <div class="relative bg-white dark:bg-zinc-900 border dark:border-zinc-800 w-[92%] max-w-lg rounded-2xl shadow-elev p-4 fade-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Editar comida</h3>
        <button class="btn btn-ghost" onclick="cerrarModalComida()">‚úñ</button>
      </div>

      <div class="mb-3 border-b dark:border-zinc-800 flex gap-2">
        <button id="tabManualBtn" class="btn btn-ghost" onclick="setModalTab('manual')">Escribir manual</button>
        <button id="tabRecetasBtn" class="btn btn-ghost" onclick="setModalTab('recetas')">Elegir guardada</button>
      </div>

      <!-- Manual -->
      <div id="modalManual" class="space-y-2">
        <label class="block text-sm">Nombre del plato</label>
        <input id="inputNombre" class="input" placeholder="Ej: Ensalada de pollo" />
        <label class="block text-sm mt-2">Ingredientes</label>
        <div id="ingredientesList" class="max-h-40 overflow-y-auto border dark:border-zinc-800 rounded-lg p-2 space-y-2">
          <!-- items -->
        </div>
        <div class="flex gap-2 mt-2">
          <button class="btn btn-ghost" onclick="agregarIngrediente()">+ Ingrediente</button>
        </div>
        <div class="flex justify-end gap-2 mt-3">
          <button class="btn" onclick="cerrarModalComida()">Cancelar</button>
          <button class="btn btn-primary" onclick="guardarComida()">Guardar</button>
        </div>
      </div>

      <!-- Elegir Receta -->
      <div id="modalElegirReceta" class="hidden space-y-2">
        <input id="buscarRecetaModal" class="input" placeholder="Buscar receta..." oninput="renderRecetasEnModal()" />
        <div id="listaRecetasModal" class="max-h-64 overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar borrado comida -->
  <div id="modalConfirmar" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 backdrop fade-enter backdrop"></div>
    <div class="relative bg-white dark:bg-zinc-900 border dark:border-zinc-800 w-[92%] max-w-md rounded-2xl shadow-elev p-4 fade-enter">
      <h3 class="text-lg font-semibold mb-2">¬øEliminar comida?</h3>
      <p class="opacity-80 mb-4">Esta acci√≥n no se puede deshacer.</p>
      <div class="flex justify-end gap-2">
        <button class="btn" onclick="cerrarModalConfirmar()">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmarBorrado()">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal Lista de la compra -->
  <div id="modalCompra" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 backdrop fade-enter backdrop"></div>
    <div class="relative bg-white dark:bg-zinc-900 border dark:border-zinc-800 w-[92%] max-w-lg rounded-2xl shadow-elev p-4 fade-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Lista de la compra</h3>
        <button class="btn btn-ghost" onclick="cerrarModalCompra()">‚úñ</button>
      </div>

      <div class="flex gap-2 mb-3">
        <input id="inputCompra" class="input" placeholder="A√±adir producto..." onkeydown="if(event.key==='Enter'){addCompraItem()}" />
        <button class="btn btn-success" onclick="addCompraItem()">A√±adir</button>
      </div>

      <div id="listaCompraContenido" class="max-h-64 overflow-y-auto space-y-2"></div>

      <div class="flex justify-between mt-4">
        <button class="btn btn-ghost" onclick="borrarMarcadosCompra()">Borrar marcados</button>
        <button class="btn btn-danger" onclick="borrarTodoCompra()">Vaciar lista</button>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Receta -->
  <div id="modalReceta" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 backdrop fade-enter backdrop"></div>
    <div class="relative bg-white dark:bg-zinc-900 border dark:border-zinc-800 w-[92%] max-w-lg rounded-2xl shadow-elev p-4 fade-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold" id="recetaModalTitulo">Nueva receta</h3>
        <button class="btn btn-ghost" onclick="cerrarModalReceta()">‚úñ</button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Nombre</label>
          <input id="recetaNombre" class="input" />
        </div>
        <div>
          <label class="block text-sm mb-1">Descripci√≥n</label>
          <textarea id="recetaDesc" class="input h-24"></textarea>
        </div>
        <div>
          <label class="block text-sm mb-1">Ingredientes</label>
          <div id="recetaIngList" class="border dark:border-zinc-800 rounded-lg p-2 space-y-2 max-h-40 overflow-y-auto"></div>
          <button class="btn btn-ghost mt-2" onclick="recetaAgregarIng()">+ Ingrediente</button>
        </div>
        <div>
          <label class="block text-sm mb-1">Foto (opcional)</label>
          <input id="recetaFoto" type="file" accept="image/*" class="input" onchange="recetaCargarFoto(event)" />
          <img id="recetaPreview" class="mt-2 max-h-40 rounded-lg hidden" alt="Vista previa" />
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <button class="btn" onclick="cerrarModalReceta()">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarReceta()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-20 right-4 px-3 py-2 rounded-lg text-white bg-blue-600 shadow hidden">Hecho</div>

  <!-- ========== SCRIPT ========== -->
  <script>
    // ---------- Estado y constantes ----------
    const franjas = ["desayuno", "comida", "cena"];
    const dias = ["lunes", "martes", "mi√©rcoles", "jueves", "viernes", "s√°bado", "domingo"];
    const STORAGE_PREFIX = "planificadorComidas_";

    let semanaActual = getStartOfWeek(new Date());
    let comidaClipboard = null;
    let franjaActual = null, diaActual = null; // para modal comida
    let comidaPendienteBorrar = null; // para confirmar borrado
    let recetaEditId = null; // para editar receta

    // ---------- Utilidades ----------
    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff); d.setHours(0,0,0,0);
      return d;
    }
    function pad(n){ return String(n).padStart(2,'0'); }
    function formatoFecha(d){
      const dia=pad(d.getDate()), mes=pad(d.getMonth()+1), anio=d.getFullYear();
      return `${dia}-${mes}-${anio}`;
    }
    function semanaKey(){ return STORAGE_PREFIX + "semana_" + formatoFecha(semanaActual); }
    function getDataSemana(){ return JSON.parse(localStorage.getItem(semanaKey())) || {}; }
    function setDataSemana(data){ localStorage.setItem(semanaKey(), JSON.stringify(data)); }
    function showToast(msg='Hecho'){
      const t=document.getElementById('toast');
      t.textContent=msg; t.classList.remove('hidden');
      clearTimeout(t._to); t._to=setTimeout(()=>t.classList.add('hidden'),1800);
    }

    // ---------- Tabs ----------
    function showTab(id){
      // sections
      ['plan','recetas','chef','ajustes'].forEach(x=>{
        document.getElementById('tab-'+x).classList.toggle('hidden', x!==id);
        document.getElementById('nav-'+x).classList.toggle('active', x===id);
      });
      // defaults
      if(id==='recetas') renderRecetas();
    }

    // ---------- Tema / Apariencia ----------
    function aplicarTemaSaved(){
      const pref=localStorage.getItem(STORAGE_PREFIX+'tema')||'system';
      document.getElementById('temaSelect').value=pref;
      applyTheme(pref);
    }
    function applyTheme(mode){
      const html=document.documentElement;
      if(mode==='dark'){ html.classList.add('dark'); }
      else if(mode==='light'){ html.classList.remove('dark'); }
      else {
        // system
        const media=window.matchMedia('(prefers-color-scheme: dark)');
        media.onchange=()=>applyTheme('system');
        if(media.matches) html.classList.add('dark'); else html.classList.remove('dark');
      }
      localStorage.setItem(STORAGE_PREFIX+'tema', mode);
    }
    function cambiarTemaSelect(v){ applyTheme(v); }

    function cambiarColorCabecera(color){
      document.documentElement.style.setProperty('--accent', color);
      localStorage.setItem(STORAGE_PREFIX+'accent', color);
    }
    function syncTitulo(val){
      document.getElementById('tituloEditable').textContent = val || 'Planificador de comidas';
      guardarTitulo();
    }
    function guardarTitulo(){
      const t=document.getElementById('tituloEditable').textContent.trim();
      if(t) localStorage.setItem(STORAGE_PREFIX+'titulo', t);
      document.getElementById('tituloInputMirror')?.value = t;
    }
    function cargarTitulo(){
      const t=localStorage.getItem(STORAGE_PREFIX+'titulo');
      if(t){
        document.getElementById('tituloEditable').textContent=t;
        const m=document.getElementById('tituloInputMirror'); if(m) m.value=t;
      }
    }

    // ---------- Planificaci√≥n: render tabla ----------
    function renderTabla(){
      const tbody=document.getElementById('tbody');
      tbody.innerHTML='';
      const data=getDataSemana();
      const vis = getFranjasVisibles();

      franjas.forEach(franja=>{
        if(!vis[franja]) return;
        const tr=document.createElement('tr');

        const th=document.createElement('th');
        th.className='p-3 text-left capitalize';
        th.textContent=franja;
        th.style.background='var(--accent)';
        th.style.color='#fff';
        tr.appendChild(th);

        dias.forEach(dia=>{
          const td=document.createElement('td');
          td.className='align-top p-3';
          td.tabIndex=0;
          td.dataset.dia=dia; td.dataset.franja=franja;

          const comida = data[dia]?.[franja];
          if(comida?.nombre){
            td.classList.add('td-filled','rounded');
            td.innerHTML=`
              <div class="font-semibold text-sm mb-1 break-words">${comida.nombre}</div>
              <div class="flex flex-wrap gap-1 mb-2">
                ${(comida.ingredientes||[]).slice(0,4).map(i=>`<span class="chip">${i}</span>`).join('')}
                ${comida.ingredientes && comida.ingredientes.length>4 ? `<span class="chip">+${comida.ingredientes.length-4}</span>`:''}
              </div>
              <div class="flex flex-wrap gap-2">
                <button class="btn btn-ghost border dark:border-zinc-800" data-act="copiar">Copiar</button>
                <button class="btn btn-ghost border dark:border-zinc-800" data-act="editar">Editar</button>
                <button class="btn btn-danger" data-act="borrar">Borrar</button>
              </div>
            `;
          } else {
            td.innerHTML=`
              <div class="opacity-60 italic text-sm mb-2">Vac√≠o</div>
              <div class="flex flex-wrap gap-2">
                <button class="btn btn-primary" data-act="nuevo">+ A√±adir</button>
                ${comidaClipboard ? '<button class="btn btn-ghost border dark:border-zinc-800" data-act="pegar">Pegar</button>' : ''}
              </div>
            `;
          }

          td.addEventListener('click', (e)=>{
            const act=e.target?.dataset?.act;
            if(!act) return;
            if(act==='editar' || act==='nuevo'){
              abrirModalComida(dia, franja, comida||{nombre:'', ingredientes:[]});
            } else if(act==='borrar'){
              abrirModalConfirmar(dia, franja);
            } else if(act==='copiar'){
              comidaClipboard = JSON.parse(JSON.stringify(comida));
              showToast('Comida copiada');
              renderTabla();
            } else if(act==='pegar'){
              if(!comidaClipboard) return;
              const d=getDataSemana();
              d[dia] = d[dia]||{};
              d[dia][franja]=JSON.parse(JSON.stringify(comidaClipboard));
              setDataSemana(d);
              comidaClipboard=null;
              renderTabla();
            }
          });

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      actualizarRangoSemana();
    }

    function cambiarSemana(n){
      semanaActual.setDate(semanaActual.getDate() + n*7);
      renderTabla();
    }
    function actualizarRangoSemana(){
      const fin=new Date(semanaActual); fin.setDate(fin.getDate()+6);
      document.getElementById('rangoSemana').textContent = `${formatoFecha(semanaActual)} - ${formatoFecha(fin)}`;
    }

    // ---------- Franjas visibles (ajustes) ----------
    function getFranjasVisibles(){
      const def={desayuno:true, comida:true, cena:true};
      try { return JSON.parse(localStorage.getItem(STORAGE_PREFIX+'franjasVisibles')) || def; }
      catch(e){ return def; }
    }
    function setFranjasVisibles(vis){
      localStorage.setItem(STORAGE_PREFIX+'franjasVisibles', JSON.stringify(vis));
      renderTabla();
    }

    // ---------- Modal Comida ----------
    function abrirModalComida(dia, franja, comida){
      diaActual=dia; franjaActual=franja;
      // Prefill manual
      document.getElementById('inputNombre').value = comida?.nombre || '';
      cargarIngredientesModal(comida?.ingredientes || []);
      // Modal recetas
      document.getElementById('buscarRecetaModal').value='';
      renderRecetasEnModal();

      setModalTab('manual');
      openModal('modalComida');
      setTimeout(()=>document.getElementById('inputNombre').focus(),50);
    }
    function cerrarModalComida(){ closeModal('modalComida'); }

    function setModalTab(which){
      document.getElementById('modalManual').classList.toggle('hidden', which!=='manual');
      document.getElementById('modalElegirReceta').classList.toggle('hidden', which!=='recetas');
      document.getElementById('tabManualBtn').classList.toggle('bg-black/5', which==='manual');
      document.getElementById('tabRecetasBtn').classList.toggle('bg-black/5', which==='recetas');
      document.getElementById('tabManualBtn').classList.toggle('dark:bg-white/10', which==='manual');
      document.getElementById('tabRecetasBtn').classList.toggle('dark:bg-white/10', which==='recetas');
    }

    function cargarIngredientesModal(arr){
      const cont=document.getElementById('ingredientesList');
      cont.innerHTML='';
      arr.forEach((ing,i)=>{
        const row=document.createElement('div');
        row.className='flex items-center gap-2';
        row.innerHTML=`
          <input class="input" value="${escapeHtml(ing)}" />
          <button class="btn btn-danger">‚úñ</button>
        `;
        row.querySelector('button').onclick=()=>row.remove();
        cont.appendChild(row);
      });
    }
    function agregarIngrediente(){
      const cont=document.getElementById('ingredientesList');
      const row=document.createElement('div');
      row.className='flex items-center gap-2';
      row.innerHTML=`
        <input class="input" placeholder="Ingrediente" />
        <button class="btn btn-danger">‚úñ</button>
      `;
      row.querySelector('button').onclick=()=>row.remove();
      cont.appendChild(row);
      row.querySelector('input').focus();
    }

    function guardarComida(){
      if(!diaActual || !franjaActual) return;
      const nombre=document.getElementById('inputNombre').value.trim();
      if(!nombre){ showToast('A√±ade un nombre'); return; }

      const ings = [...document.querySelectorAll('#ingredientesList input')]
        .map(i=>i.value.trim()).filter(Boolean);

      const d=getDataSemana();
      d[diaActual] = d[diaActual] || {};
      d[diaActual][franjaActual] = { nombre, ingredientes: ings };
      setDataSemana(d);
      cerrarModalComida(); renderTabla(); showToast('Comida guardada');
    }

    // Elegir receta guardada en el modal
    function renderRecetasEnModal(){
      const q = document.getElementById('buscarRecetaModal').value.toLowerCase().trim();
      const cont = document.getElementById('listaRecetasModal');
      cont.innerHTML='';
      const recetas = getRecetas();
      const fil = recetas.filter(r=>{
        const h = (r.nombre||'').toLowerCase();
        const d = (r.desc||'').toLowerCase();
        const ing = (r.ing||[]).join(' ').toLowerCase();
        return !q || h.includes(q) || d.includes(q) || ing.includes(q);
      });
      if(fil.length===0){
        cont.innerHTML = `<p class="text-sm opacity-70">No hay resultados.</p>`;
        return;
      }
      fil.forEach(r=>{
        const card=document.createElement('div');
        card.className='border dark:border-zinc-800 rounded-lg p-3 flex items-center gap-3';
        const img = r.foto ? `<img src="${r.foto}" class="w-16 h-16 object-cover rounded-lg border dark:border-zinc-800" alt="${escapeHtml(r.nombre)}"/>` : `<div class="w-16 h-16 rounded-lg bg-black/5 dark:bg-white/10 flex items-center justify-center">üçΩÔ∏è</div>`;
        card.innerHTML=`
          ${img}
          <div class="flex-1">
            <div class="font-semibold">${escapeHtml(r.nombre||'Sin t√≠tulo')}</div>
            <div class="text-xs opacity-70 line-clamp-2">${escapeHtml(r.desc||'')}</div>
          </div>
          <button class="btn btn-primary">Usar</button>
        `;
        card.querySelector('button').onclick=()=>{
          // Rellenar los campos manuales con la receta para poder ‚ÄúGuardar‚Äù
          document.getElementById('inputNombre').value = r.nombre || '';
          const contIng=document.getElementById('ingredientesList');
          contIng.innerHTML='';
          (r.ing||[]).forEach(ing=>{
            const row=document.createElement('div');
            row.className='flex items-center gap-2';
            row.innerHTML=`
              <input class="input" value="${escapeHtml(ing)}" />
              <button class="btn btn-danger">‚úñ</button>
            `;
            row.querySelector('button').onclick=()=>row.remove();
            contIng.appendChild(row);
          });
          setModalTab('manual');
          showToast('Receta cargada en el formulario');
        };
        cont.appendChild(card);
      });
    }

    function abrirModalConfirmar(dia, franja){
      comidaPendienteBorrar = {dia, franja};
      openModal('modalConfirmar');
    }
    function cerrarModalConfirmar(){ closeModal('modalConfirmar'); }
    function confirmarBorrado(){
      if(!comidaPendienteBorrar) return;
      const {dia, franja} = comidaPendienteBorrar;
      const d=getDataSemana();
      if(d[dia]){
        delete d[dia][franja];
        if(Object.keys(d[dia]).length===0) delete d[dia];
        setDataSemana(d);
      }
      cerrarModalConfirmar(); renderTabla(); showToast('Comida eliminada');
    }

    function vaciarSemanaModal(){
      // Reutilizamos confirm modal con flag especial
      comidaPendienteBorrar = { all:true };
      document.querySelector('#modalConfirmar h3').textContent='¬øVaciar semana?';
      document.querySelector('#modalConfirmar p').textContent='Eliminar√° todas las franjas de esta semana.';
      openModal('modalConfirmar');
    }

    // Sobrecarga para vaciar todo al confirmar
    const _confirmarOriginal = confirmarBorrado;
    confirmarBorrado = function(){
      if(comidaPendienteBorrar?.all){
        localStorage.removeItem(semanaKey());
        cerrarModalConfirmar(); renderTabla(); showToast('Semana vaciada');
        // restaurar textos
        document.querySelector('#modalConfirmar h3').textContent='¬øEliminar comida?';
        document.querySelector('#modalConfirmar p').textContent='Esta acci√≥n no se puede deshacer.';
        comidaPendienteBorrar=null;
        return;
      }
      // si no es vaciado total, ejecutar original
      const {dia, franja} = comidaPendienteBorrar || {};
      if(!dia || !franja){ cerrarModalConfirmar(); return; }
      const d=getDataSemana();
      if(d[dia]){
        delete d[dia][franja];
        if(Object.keys(d[dia]).length===0) delete d[dia];
        setDataSemana(d);
      }
      cerrarModalConfirmar(); renderTabla(); showToast('Comida eliminada');
    }

    // ---------- Lista de la compra ----------
    function getCompra(){ return JSON.parse(localStorage.getItem(STORAGE_PREFIX+'compra')) || []; }
    function setCompra(a){ localStorage.setItem(STORAGE_PREFIX+'compra', JSON.stringify(a)); }
    function abrirModalCompra(){
      renderCompra();
      openModal('modalCompra');
      setTimeout(()=>document.getElementById('inputCompra').focus(),50);
    }
    function cerrarModalCompra(){ closeModal('modalCompra'); }

    function addCompraItem(){
      const inp=document.getElementById('inputCompra');
      const txt=inp.value.trim(); if(!txt) return;
      const items=getCompra();
      items.push({id:crypto.randomUUID(), txt, done:false});
      setCompra(items); inp.value=''; renderCompra();
    }
    function toggleCompra(id){
      const items=getCompra().map(it=>it.id===id?({...it, done:!it.done}):it);
      setCompra(items); renderCompra();
    }
    function delCompra(id){
      const items=getCompra().filter(it=>it.id!==id);
      setCompra(items); renderCompra();
    }
    function borrarMarcadosCompra(){
      const items=getCompra().filter(it=>!it.done);
      setCompra(items); renderCompra();
    }
    function borrarTodoCompra(){
      setCompra([]); renderCompra();
    }
    function renderCompra(){
      const cont=document.getElementById('listaCompraContenido');
      const items=getCompra();
      cont.innerHTML='';
      if(items.length===0){
        cont.innerHTML='<p class="text-sm opacity-70">Tu lista est√° vac√≠a.</p>'; return;
      }
      items.forEach(it=>{
        const row=document.createElement('div');
        row.className='flex items-center gap-2';
        row.innerHTML=`
          <input type="checkbox" class="scale-125" ${it.done?'checked':''}/>
          <div class="flex-1 ${it.done?'line-through opacity-60':''}">${escapeHtml(it.txt)}</div>
          <button class="btn btn-ghost" title="Eliminar">üóëÔ∏è</button>
        `;
        row.querySelector('input').onchange=()=>toggleCompra(it.id);
        row.querySelector('button').onclick=()=>delCompra(it.id);
        cont.appendChild(row);
      });
    }

    // ---------- Recetas ----------
    function getRecetas(){ return JSON.parse(localStorage.getItem(STORAGE_PREFIX+'recetas')) || []; }
    function setRecetas(a){ localStorage.setItem(STORAGE_PREFIX+'recetas', JSON.stringify(a)); }
    function abrirModalNuevaReceta(){
      recetaEditId=null;
      document.getElementById('recetaModalTitulo').textContent='Nueva receta';
      document.getElementById('recetaNombre').value='';
      document.getElementById('recetaDesc').value='';
      document.getElementById('recetaIngList').innerHTML='';
      recetaAgregarIng();
      document.getElementById('recetaFoto').value='';
      document.getElementById('recetaPreview').classList.add('hidden');
      document.getElementById('recetaPreview').src='';
      openModal('modalReceta');
      setTimeout(()=>document.getElementById('recetaNombre').focus(),50);
    }
    function abrirModalEditarReceta(id){
      const r=getRecetas().find(x=>x.id===id); if(!r) return;
      recetaEditId=id;
      document.getElementById('recetaModalTitulo').textContent='Editar receta';
      document.getElementById('recetaNombre').value=r.nombre||'';
      document.getElementById('recetaDesc').value=r.desc||'';
      const list=document.getElementById('recetaIngList'); list.innerHTML='';
      (r.ing||[]).forEach(v=>{
        const row=document.createElement('div');
        row.className='flex items-center gap-2';
        row.innerHTML=`<input class="input" value="${escapeHtml(v)}"/><button class="btn btn-danger">‚úñ</button>`;
        row.querySelector('button').onclick=()=>row.remove();
        list.appendChild(row);
      });
      if((r.ing||[]).length===0) recetaAgregarIng();
      const prev=document.getElementById('recetaPreview');
      if(r.foto){ prev.src=r.foto; prev.classList.remove('hidden'); } else { prev.src=''; prev.classList.add('hidden'); }
      document.getElementById('recetaFoto').value='';
      openModal('modalReceta');
    }
    function cerrarModalReceta(){ closeModal('modalReceta'); }
    function recetaAgregarIng(){
      const list=document.getElementById('recetaIngList');
      const row=document.createElement('div');
      row.className='flex items-center gap-2';
      row.innerHTML=`<input class="input" placeholder="Ingrediente"/><button class="btn btn-danger">‚úñ</button>`;
      row.querySelector('button').onclick=()=>row.remove();
      list.appendChild(row);
    }
    function recetaCargarFoto(evt){
      const file=evt.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        const img=document.getElementById('recetaPreview');
        img.src=reader.result; img.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
    function guardarReceta(){
      const nombre=document.getElementById('recetaNombre').value.trim();
      if(!nombre){ showToast('Pon un nombre'); return; }
      const desc=document.getElementById('recetaDesc').value.trim();
      const ing=[...document.querySelectorAll('#recetaIngList input')].map(i=>i.value.trim()).filter(Boolean);
      const foto=document.getElementById('recetaPreview').src || '';

      const recetas=getRecetas();
      if(recetaEditId){
        const i=recetas.findIndex(x=>x.id===recetaEditId);
        if(i>=0) recetas[i]={...recetas[i], nombre, desc, ing, foto: (foto.startsWith('data:')?foto:'')};
      } else {
        recetas.push({id:crypto.randomUUID(), nombre, desc, ing, foto: (foto.startsWith('data:')?foto:'')});
      }
      setRecetas(recetas);
      cerrarModalReceta(); renderRecetas(); showToast('Receta guardada');
    }
    function borrarReceta(id){
      // Si una comida de la semana ten√≠a ese nombre, no lo tocamos: las comidas guardan texto e ingredientes propios en el momento.
      const recetas=getRecetas().filter(r=>r.id!==id);
      setRecetas(recetas); renderRecetas(); showToast('Receta eliminada');
    }
    function compartirReceta(id){
      const r=getRecetas().find(x=>x.id===id); if(!r) return;
      const texto = `üçΩÔ∏è ${r.nombre}\n\n${r.desc? r.desc+'\n\n':''}Ingredientes:\n- ${(r.ing||[]).join('\n- ')}`;
      if(navigator.share){
        navigator.share({title:r.nombre, text:texto}).catch(()=>{});
      } else {
        navigator.clipboard.writeText(texto).then(()=>showToast('Receta copiada'));
      }
    }
    function renderRecetas(){
      const cont=document.getElementById('listaRecetas');
      const none=document.getElementById('sinRecetas');
      const q=(document.getElementById('buscadorRecetas').value||'').toLowerCase().trim();
      const recetas=getRecetas().filter(r=>{
        const h=(r.nombre||'').toLowerCase();
        const d=(r.desc||'').toLowerCase();
        const ing=(r.ing||[]).join(' ').toLowerCase();
        return !q || h.includes(q)||d.includes(q)||ing.includes(q);
      });
      cont.innerHTML='';
      none.classList.toggle('hidden', recetas.length>0);
      recetas.forEach(r=>{
        const card=document.createElement('div');
        card.className='rounded-xl overflow-hidden border dark:border-zinc-800 bg-white dark:bg-zinc-900 shadow';
        card.innerHTML=`
          <div class="h-36 bg-black/5 dark:bg-white/10 flex items-center justify-center overflow-hidden">
            ${r.foto ? `<img src="${r.foto}" class="w-full h-36 object-cover" alt="${escapeHtml(r.nombre)}"/>` : '<div class="text-4xl">üçΩÔ∏è</div>'}
          </div>
          <div class="p-3 space-y-2">
            <div class="font-semibold">${escapeHtml(r.nombre||'Sin t√≠tulo')}</div>
            <div class="text-sm opacity-80 min-h-10">${escapeHtml(r.desc||'')}</div>
            <div class="flex flex-wrap gap-1">
              ${(r.ing||[]).slice(0,5).map(i=>`<span class="chip">${escapeHtml(i)}</span>`).join('')}
              ${r.ing && r.ing.length>5 ? `<span class="chip">+${r.ing.length-5}</span>`:''}
            </div>
            <div class="flex justify-end gap-2 pt-2">
              <button class="btn btn-ghost border dark:border-zinc-700" title="Compartir">üîó</button>
              <button class="btn btn-ghost border dark:border-zinc-700" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-danger" title="Borrar">üóëÔ∏è</button>
            </div>
          </div>
        `;
        const [btnShare, btnEdit, btnDel] = card.querySelectorAll('button');
        btnShare.onclick=()=>compartirReceta(r.id);
        btnEdit.onclick=()=>abrirModalEditarReceta(r.id);
        btnDel.onclick=()=>borrarReceta(r.id);
        cont.appendChild(card);
      });
    }

    // ---------- Exportar / Importar / Reset ----------
    function exportarDatos(){
      const data = {};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k.startsWith(STORAGE_PREFIX)){
          data[k]=localStorage.getItem(k);
        }
      }
      const blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='planificador_datos.json'; a.click();
      URL.revokeObjectURL(url);
    }
    function importarDatos(file){
      if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const obj=JSON.parse(reader.result);
          Object.keys(obj).forEach(k=>{
            if(k.startsWith(STORAGE_PREFIX)) localStorage.setItem(k, obj[k]);
          });
          showToast('Datos importados');
          postInit();
        }catch(e){ showToast('Error al importar'); }
      };
      reader.readAsText(file);
    }
    function confirmarReset(){
      // Reutilizamos modalConfirmar con otra sem√°ntica
      comidaPendienteBorrar = { resetAll:true };
      document.querySelector('#modalConfirmar h3').textContent='¬øRestablecer todo?';
      document.querySelector('#modalConfirmar p').textContent='Se borrar√°n recetas, planificaci√≥n, lista y ajustes.';
      openModal('modalConfirmar');
    }
    // Hook para detectar resetAll
    const _confirmarBorrado2 = confirmarBorrado;
    confirmarBorrado = function(){
      if(comidaPendienteBorrar?.resetAll){
        // limpiar
        Object.keys(localStorage).forEach(k=>{
          if(k.startsWith(STORAGE_PREFIX)) localStorage.removeItem(k);
        });
        cerrarModalConfirmar();
        // Restaurar textos del modal
        document.querySelector('#modalConfirmar h3').textContent='¬øEliminar comida?';
        document.querySelector('#modalConfirmar p').textContent='Esta acci√≥n no se puede deshacer.';
        comidaPendienteBorrar=null;
        postInit();
        showToast('App restablecida');
        return;
      }
      // fallback al anterior (puede ser vaciar semana o borrar comida)
      _confirmarOriginal();
    }

    // ---------- Helpers UI ----------
    function openModal(id){
      const el=document.getElementById(id);
      el.classList.remove('hidden');
      el.classList.add('flex');
    }
    function closeModal(id){
      const el=document.getElementById(id);
      el.classList.remove('flex');
      el.classList.add('hidden');
    }
    function escapeHtml(str=''){
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ---------- Eventos iniciales ----------
    function initAjustesUI(){
      // Tema
      aplicarTemaSaved();
      const acc = localStorage.getItem(STORAGE_PREFIX+'accent') || '#4a4a4a';
      cambiarColorCabecera(acc);
      const colorInput=document.getElementById('colorCabecera'); if(colorInput) colorInput.value=acc;

      // Franjas
      const vis=getFranjasVisibles();
      document.getElementById('chkDesayuno').checked=!!vis.desayuno;
      document.getElementById('chkComida').checked=!!vis.comida;
      document.getElementById('chkCena').checked=!!vis.cena;

      ['chkDesayuno','chkComida','chkCena'].forEach(id=>{
        document.getElementById(id).addEventListener('change', ()=>{
          const v={
            desayuno: document.getElementById('chkDesayuno').checked,
            comida: document.getElementById('chkComida').checked,
            cena: document.getElementById('chkCena').checked
          };
          setFranjasVisibles(v);
        });
      });
    }

    function postInit(){
      cargarTitulo();
      initAjustesUI();
      renderTabla();
      renderRecetas();
      document.getElementById('btnListaCompra').onclick=abrirModalCompra;
      // Sincronizar input espejo del t√≠tulo si existe
      const t = localStorage.getItem(STORAGE_PREFIX+'titulo')||'';
      const mirror=document.getElementById('tituloInputMirror');
      if(mirror) mirror.value=t;
      // default tab
      showTab('plan');
    }

    document.addEventListener('DOMContentLoaded', postInit);
  </script>
</body>
      </html>
