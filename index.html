<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meal Planner Pro — v2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- LZ-String CDN para compartir recetas mediante URL cortas -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <!-- 💅 CSS se pegará en la Parte 2 dentro de <style> -->
  <style id="APP_CSS_PLACEHOLDER">:root{
  --bg:#ffffff; --surface:#f6f7fb; --card:#ffffff; --text:#1f2330; --muted:#6b7280; --accent:#6c5ce7; --accent-ink:#ffffff; --border:#e5e7eb; --shadow:0 8px 24px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}

/* Dark mode */
body.dark{--bg:#0e1116;--surface:#131722;--card:#151a25;--text:#e5e7eb;--muted:#9aa0aa;--border:#1f2533;--shadow:0 10px 28px rgba(0,0,0,.35)}

/* Layout */
.app-header{position:fixed;top:0;left:0;right:0;height:56px;background:var(--bg);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:0 12px;z-index:30}
.app-header h1{font-size:16px;font-weight:600;margin:0}
.header-left,.header-right{display:flex;gap:6px}

.views{padding-top:56px;padding-bottom:64px}
.view{display:none;height:calc(100vh - 56px - 64px);overflow-y:auto;-webkit-overflow-scrolling:touch}
.view.active{display:block}

.container{max-width:1000px;margin:0 auto;padding:16px}
.container.gap>*+*{margin-top:14px}

.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:var(--bg);border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(4,1fr);z-index:40}
.tab-item{appearance:none;border:none;background:none;padding:6px 4px;font:inherit;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:2px}
.tab-item span{font-size:11px}
.tab-item.active{color:var(--accent)}

/* Buttons */
.btn{appearance:none;border:none;background:var(--accent);color:var(--accent-ink);padding:10px 14px;border-radius:12px;font-weight:600;box-shadow:var(--shadow);cursor:pointer}
.btn.ghost{background:transparent;color:var(--text);Border:1px solid var(--border);box-shadow:none}
.btn.danger{background:#ef4444}
.icon-btn{appearance:none;border:none;background:transparent;color:var(--text);width:36px;height:36px;border-radius:10px;display:grid;place-items:center}
.icon-btn:hover{background:var(--surface)}
.file-btn{position:relative;overflow:hidden}
.file-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}

.toolbar{display:flex;align-items:center;gap:10px}
.toolbar.wrap{flex-wrap:wrap}
.spacer{flex:1}
.badge{display:inline-block;background:var(--surface);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}

/* Planner */
.week-nav{display:flex;align-items:center;gap:10px}
.week-label{font-weight:600}
.legend{margin-top:10px;color:var(--muted);font-size:12px}

.planner-grid{display:grid;gap:10px}
/* responsive grid: first row headers, then days*slots */
.planner-grid .row{display:grid;grid-template-columns:120px repeat(7,1fr);gap:10px}
.planner-grid .cell,.planner-grid .head{border:1px dashed var(--border);background:var(--card);min-height:72px;border-radius:14px;padding:8px}
.planner-grid .head{font-weight:600;text-align:center;background:var(--surface);border-style:solid}
.planner-grid .slot-name{display:flex;align-items:center;justify-content:center;font-weight:600;background:var(--surface)}
.planner-grid .cell{position:relative}
.planner-grid .cell.filled{background:linear-gradient(0deg, rgba(108,92,231,0.06), rgba(108,92,231,0.06)), var(--card);}
.cell .item-title{font-weight:600;margin-bottom:6px}
.cell .item-sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cell .cell-actions{position:absolute;right:6px;bottom:6px;display:flex;gap:6px}
.cell.dragging{opacity:.6;outline:2px dashed var(--accent)}
.cell.drop-target{outline:2px solid var(--accent)}

/* Cards grid */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.card.pad{padding:14px}
.card .thumb{aspect-ratio:16/10;background:var(--surface);display:block;object-fit:cover;width:100%}
.card .content{padding:12px}
.card .title{font-weight:700}
.card .desc{color:var(--muted);font-size:14px;margin-top:4px}
.card .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:10px}

/* Segmented */
.tabs-switch{display:flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.tabs-switch .seg{padding:10px 14px;border:none;background:transparent;color:var(--text)}
.tabs-switch .seg.active{background:var(--surface);font-weight:600}

/* Search */
.search-box{display:flex;gap:8px;align-items:center}
.search-box input{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}
.search-box select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}

/* AI */
.hero{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.ai-box{display:flex;gap:8px}
.ai-box input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}
.ai-output{display:grid;gap:12px;margin-top:12px}

/* Switch */
.switch{display:inline-flex;align-items:center;gap:8px;font-weight:600}
.switch input{display:none}
.switch span{width:44px;height:26px;border-radius:999px;background:var(--border);position:relative;transition:.2s}
.switch span:after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.2s;box-shadow:var(--shadow)}
.switch input:checked+span{background:var(--accent)}
.switch input:checked+span:after{transform:translateX(18px)}

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.35)}
.modal-dialog{position:relative;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);width:min(680px,92vw);max-height:80vh;display:flex;flex-direction:column}
.modal-header,.modal-footer{padding:12px 14px;border-bottom:1px solid var(--border)}
.modal-header{display:flex;align-items:center;justify-content:space-between}
.modal-footer{border-top:1px solid var(--border);border-bottom:none;display:flex;gap:8px;justify-content:flex-end}
.modal-body{padding:14px;overflow:auto}
.modal .input, .modal textarea, .modal select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}
.modal .grid{display:grid;gap:10px}
.modal .grid.cols-2{grid-template-columns:1fr 1fr}

/* Toast */
.toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:10px 14px;border-radius:999px;box-shadow:var(--shadow);opacity:0;transition:opacity .2s ease;z-index:120}
.toast.show{opacity:1}

/* To-Do list */
.todo{display:grid;gap:6px}
.todo-item{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);padding:8px;border-radius:10px}
.todo-item input[type="text"]{flex:1;background:transparent;border:none;color:inherit;outline:none}
.todo-item .chk{width:18px;height:18px}
.todo-item .del{border:none;background:transparent;color:var(--muted);cursor:pointer}
.todo-footer{display:flex;gap:8px}

/* Helpers */
.row{display:flex;gap:8px;align-items:center}
.wrap{flex-wrap:wrap}
.hidden{display:none !important}
.muted{color:var(--muted)}
.pad-0{padding:0}

/* Print recipe */
@media print{
  .app-header,.bottom-nav{display:none}
  .view{height:auto}
}
</style>
</head>
<body>
  <!-- Header fijo -->
  <header class="app-header">
    <div class="header-left">
      <button id="menuBtn" class="icon-btn" aria-label="Menú" title="Menú">
        <svg viewBox="0 0 24 24" width="22" height="22"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      </button>
    </div>
    <h1 id="headerTitle">Planificador Semanal</h1>
    <div class="header-right">
      <button id="editTitleBtn" class="icon-btn" title="Editar título">
        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="currentColor"/></svg>
      </button>
    </div>
  </header>

  <!-- Vistas SPA -->
  <main class="views">
    <!-- 🗓 Planificador Semanal -->
    <section id="view-planner" class="view active" aria-labelledby="plannerTab">
      <div class="container">
        <div class="toolbar">
          <div class="week-nav">
            <button id="prevWeekBtn" class="btn ghost" title="Semana anterior">◀</button>
            <div id="weekLabel" class="week-label">Semana</div>
            <button id="nextWeekBtn" class="btn ghost" title="Semana siguiente">▶</button>
          </div>
          <div class="spacer"></div>
          <button id="shoppingListBtn" class="btn">Lista de la compra</button>
        </div>

        <div id="plannerGrid" class="planner-grid" aria-live="polite"></div>
        <div class="legend">
          <span class="dot filled"></span> Celda ocupada &nbsp;•&nbsp; Arrastra para mover &nbsp;•&nbsp; Toca para editar
        </div>
      </div>
    </section>

    <!-- 📚 Recetas -->
    <section id="view-recipes" class="view" aria-labelledby="recipesTab">
      <div class="container gap">
        <div class="toolbar wrap">
          <div class="tabs-switch">
            <button id="recipesViewBtn" class="seg active">Recetas</button>
            <button id="albumsViewBtn" class="seg">Álbumes</button>
          </div>
          <div class="spacer"></div>
          <div class="search-box">
            <input id="recipeSearch" type="search" placeholder="Buscar recetas..." />
            <select id="recipeSort">
              <option value="recent">Más recientes</option>
              <option value="oldest">Más antiguas</option>
              <option value="az">A-Z</option>
            </select>
          </div>
          <button id="newRecipeBtn" class="btn">Nueva receta</button>
        </div>

        <div id="recipesList" class="cards-grid"></div>
        
        <!-- Álbumes -->
        <div id="albumsWrap" class="albums-wrap hidden">
          <div class="toolbar wrap">
            <div class="spacer"></div>
            <button id="newAlbumBtn" class="btn ghost">Crear álbum</button>
          </div>
          <div id="albumsList" class="cards-grid"></div>
        </div>
      </div>
    </section>

    <!-- 👨‍🍳 Chef IA -->
    <section id="view-ai" class="view" aria-labelledby="aiTab">
      <div class="container">
        <div class="hero">
          <div class="badge">Chef · Próximamente</div>
          <h2>Ideas de recetas con IA</h2>
          <p>Proximamente. Estoy trabajando para que esté disponible lo antes posible. 😉</p>
        </div>
        <div class="ai-box">
          <input id="aiPrompt" type="text" placeholder="Escribe ingredientes que tienes (p. ej. pollo, arroz, tomate)" />
          <button id="aiMockBtn" class="btn">Sugerir</button>
        </div>
        <div id="aiOutput" class="ai-output"></div>
      </div>
    </section>

    <!-- ⚙️ Ajustes -->
    <section id="view-settings" class="view" aria-labelledby="settingsTab">
      <div class="container gap">
        <div class="card pad">
          <h3>Personalización</h3>
          <div class="row">
            <label class="row">Color de acento: <input id="accentPicker" type="color" value="#6c5ce7" /></label>
            <label class="switch">Modo oscuro <input id="darkToggle" type="checkbox"><span></span></label>
          </div>
        </div>

        <div class="card pad">
          <h3>Franjas del día</h3>
          <p>Oculta o muestra las franjas que quieras usar.</p>
          <div class="row wrap">
            <label class="switch">Desayuno <input id="breakfastToggle" type="checkbox"><span></span></label>
            <label class="switch">Comida <input id="lunchToggle" type="checkbox"><span></span></label>
            <label class="switch">Cena <input id="dinnerToggle" type="checkbox"><span></span></label>
          </div>
        </div>

        <div class="card pad">
          <h3>Cuenta</h3>
          <div class="row wrap">
            <input id="emailInput" type="email" placeholder="email@ejemplo.com" />
            <input id="passInput" type="password" placeholder="Contraseña" />
            <button id="loginBtn" class="btn">Iniciar sesión</button>
            <button id="logoutBtn" class="btn ghost">Cerrar sesión</button>
          </div>
          <div id="loginState" class="muted">Sin sesión</div>
        </div>

        <div class="card pad">
          <h3>Respaldo de datos</h3>
          <div class="row wrap">
            <button id="exportBtn" class="btn">Exportar JSON</button>
            <label class="btn ghost file-btn">Importar JSON<input type="file" id="importFile" accept="application/json"></label>
          </div>
          <small class="muted">Se almacenan en <code>localStorage</code> y puedes migrarlos a otro dispositivo.</small>
        </div>
      </div>
    </section>
  </main>

  <!-- Menú inferior fijo -->
  <nav class="bottom-nav" role="tablist">
    <button class="tab-item active" data-tab="planner" id="plannerTab" role="tab">🗓<span>Plan</span></button>
    <button class="tab-item" data-tab="recipes" id="recipesTab" role="tab">📚<span>Recetas</span></button>
    <button class="tab-item" data-tab="ai" id="aiTab" role="tab">👨‍🍳<span>Chef IA</span></button>
    <button class="tab-item" data-tab="settings" id="settingsTab" role="tab">⚙️<span>Ajustes</span></button>
  </nav>

  <!-- Modales reutilizables -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-overlay" data-close></div>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 id="modalTitle">Modal</h3>
        <button class="icon-btn" data-close aria-label="Cerrar">✕</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn ghost" data-close>Cancelar</button>
        <button class="btn" id="modalOkBtn">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- 🧠 JS se pegará en la Parte 3 dentro de <script> -->
  <script id="APP_JS_PLACEHOLDER">// =============================
// Meal Planner Pro — v2 (SPA) — JS corregido
// =============================
(function(){
  'use strict';
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  // ---------- Estado ----------
  const STORAGE_KEY = 'mealplanner.v2';
  let rafRender = null;
  let state = {
    activeTab: 'planner',
    titlePerView: { planner:'Planificador Semanal', recipes:'Mis Recetas', ai:'Chef IA', settings:'Ajustes' },
    weekStart: null, // se inicializa en load()
    settings: { accent:'#6c5ce7', dark:false, slots:{ breakfast:true, lunch:true, dinner:true } },
    account: { email:'', token:'' },
    recipes: [],
    albums: [],
    planner: {}, // { yyyy-mm-dd: {breakfast:{type:'recipe'|'manual', id, title, note}, ...} }
    shopping: { items: [] }, // lista manual
    clipboard: null // para copiar/pegar celdas
  };

  // ---------- Utiles de fecha ----------
  function pad(n){return n<10?'0'+n:n}
  function fmtDate(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
  function startOfWeek(d){const x=new Date(d);const day=x.getDay();const diff=(day===0?6:day-1);x.setDate(x.getDate()-diff);x.setHours(0,0,0,0);return x}
  function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}

  // ---------- Render scheduling & persistencia ----------
  function scheduleRender(){
    if(rafRender) cancelAnimationFrame(rafRender);
    rafRender = requestAnimationFrame(()=>{ rafRender = null; try{ render(); }catch(e){ console.error('render err', e); } });
  }
  function save(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    catch(e){ console.warn('save err', e); }
    scheduleRender();
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        // merge conservando funciones
        state = Object.assign(state, parsed);
        if(parsed.weekStart) state.weekStart = new Date(parsed.weekStart);
      } else {
        state.weekStart = startOfWeek(new Date());
      }
    }catch(e){ console.warn('load err', e); state.weekStart = state.weekStart || startOfWeek(new Date()); }
    if(!state.recipes || !state.recipes.length){ seed(); save(); }
  }

  // Datos de prueba
  function seed(){
    const r1 = { id:id(), name:'Pasta cremosa con champiñones', desc:'Sencilla y rápida', image:'https://images.unsplash.com/photo-1521389508051-d7ffb5dc8bbf?auto=format&fit=crop&w=1200&q=60', ingredients:['Pasta','Nata','Champiñones','Ajo','Parmesano'], steps:['Hervir pasta','Saltear champiñones','Mezclar con nata','Servir con queso'], notes:['Añadir perejil'], createdAt:Date.now() };
    const r2 = { id:id(), name:'Ensalada mediterránea', desc:'Ligera y fresca', image:'https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=1200&q=60', ingredients:['Lechuga','Tomate','Pepino','Queso feta','Aceitunas'], steps:['Trocear','Aliñar'], notes:['Ideal con pan pita'], createdAt:Date.now()-86400000 };
    const alb = { id:id(), name:'Favoritas', desc:'Recetas top', image:r1.image, recipeIds:[] };
    state.recipes = [r1,r2];
    state.albums = [alb];
    // planner demo: hoy comida = r1
    const today = fmtDate(new Date());
    state.planner[today] = { lunch:{ type:'recipe', id:r1.id } };
    state.shopping.items = [];
  }

  // ---------- Helpers faltantes (evitan ReferenceError) ----------
  function headCell(txt){
    const e = document.createElement('div'); e.className = 'head'; e.textContent = txt; return e;
  }
  function slotNameCell(txt){
    const e = document.createElement('div'); e.className = 'slot-name'; e.textContent = txt; return e;
  }

  // ---------- Temas ----------
  function setAccent(c){ if(!c) return; document.documentElement.style.setProperty('--accent', c); }
  function setDark(on){ document.body.classList.toggle('dark', !!on); }

  // ---------- Utils DOM y auxiliares ----------
  function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e }
  function btn(label, variant){ const b=document.createElement('button'); b.className='btn'+(variant?' '+variant:''); b.textContent=label; return b }
  function smallBtn(label){ const b=document.createElement('button'); b.className='btn ghost'; b.style.padding='6px 8px'; b.style.borderRadius='8px'; b.textContent=label; return b }
  function id(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
  function clone(o){ return o? JSON.parse(JSON.stringify(o)) : o }
  function escape(s=''){ return (s+'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]) ) }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }) }

  // ---------- Tabs (bottom nav) ----------
  (function bindTabs(){
    qsa('.tab-item').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const t = btn.dataset.tab; if(!t) return; state.activeTab = t; save(); });
    });
  })();

  // ---------- Header & título ----------
  if(qs('#editTitleBtn')){
    qs('#editTitleBtn').addEventListener('click', ()=>{
      openModal('Editar título', `
        <div class="grid">
          <label>Nuevo título<input class="input" id="titleInput" value="${escape(state.titlePerView[state.activeTab]||'')}" /></label>
        </div>`, {
        ok:'Guardar', onOk:()=>{
          state.titlePerView[state.activeTab] = qs('#titleInput').value.trim()||state.titlePerView[state.activeTab];
          save();
        }
      })
    });
  }

  // ---------- Semana nav ----------
  if(qs('#prevWeekBtn')) qs('#prevWeekBtn').addEventListener('click', ()=>{ state.weekStart = addDays(state.weekStart,-7); save(); });
  if(qs('#nextWeekBtn')) qs('#nextWeekBtn').addEventListener('click', ()=>{ state.weekStart = addDays(state.weekStart, 7); save(); });

  // ---------- Ajustes ----------
  if(qs('#accentPicker')) qs('#accentPicker').addEventListener('input', e=>{ state.settings.accent=e.target.value; setAccent(e.target.value); save(); });
  if(qs('#darkToggle')) qs('#darkToggle').addEventListener('change', e=>{ state.settings.dark=e.target.checked; setDark(e.target.checked); save(); });
  if(qs('#breakfastToggle')) qs('#breakfastToggle').addEventListener('change', e=>{ state.settings.slots.breakfast=e.target.checked; save(); });
  if(qs('#lunchToggle')) qs('#lunchToggle').addEventListener('change', e=>{ state.settings.slots.lunch=e.target.checked; save(); });
  if(qs('#dinnerToggle')) qs('#dinnerToggle').addEventListener('change', e=>{ state.settings.slots.dinner=e.target.checked; save(); });

  // Login local
  if(qs('#loginBtn')){
    qs('#loginBtn').addEventListener('click', ()=>{
      const email=qs('#emailInput').value.trim(); const pass=qs('#passInput').value.trim();
      if(!email||!pass){ toast('Completa email y contraseña'); return; }
      state.account.email=email; state.account.token = btoa(email+':'+pass); save(); toast('Sesión iniciada');
    });
  }
  if(qs('#logoutBtn')) qs('#logoutBtn').addEventListener('click', ()=>{ state.account={email:'',token:''}; save(); toast('Sesión cerrada'); });

  // Export/Import
  if(qs('#exportBtn')){
    qs('#exportBtn').addEventListener('click', ()=>{
      try{
        const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='mealplanner-backup.json'; a.click(); URL.revokeObjectURL(a.href);
        toast('Exportado');
      }catch(e){ console.warn(e); toast('Error al exportar'); }
    });
  }
  if(qs('#importFile')){
    qs('#importFile').addEventListener('change', async e=>{
      const file = e.target.files[0]; if(!file) return;
      try{ const txt = await file.text(); const data = JSON.parse(txt); data.weekStart && (data.weekStart=new Date(data.weekStart)); state = Object.assign(state, data); save(); toast('Importado'); }
      catch(err){ console.warn(err); toast('Archivo inválido'); }
      e.target.value='';
    });
  }

  // ---------- Lista de la compra ----------
  if(qs('#shoppingListBtn')) qs('#shoppingListBtn').addEventListener('click', ()=> openShoppingModal());
  function openShoppingModal(){
    openModal('Lista de la compra', `
      <div id="shoppingTodo" class="todo"></div>
      <div class="todo-footer">
        <input id="shoppingInput" class="input" placeholder="Añadir artículo..."/>
        <button id="addShoppingBtn" class="btn">Añadir</button>
        <button id="genShoppingBtn" class="btn ghost" title="Generar desde el plan">Generar</button>
      </div>
    `, { ok:'Cerrar', showOk:false, onOpen:()=>{
      renderTodo('shoppingTodo', state.shopping.items, items=>{ state.shopping.items=items; save(); });
      const addBtn = qs('#addShoppingBtn'), genBtn = qs('#genShoppingBtn');
      if(addBtn) addBtn.onclick=()=>{ const v=qs('#shoppingInput').value.trim(); if(!v) return; state.shopping.items.push({text:v,done:false}); qs('#shoppingInput').value=''; renderTodo('shoppingTodo', state.shopping.items, items=>{ state.shopping.items=items; save(); }); save(); };
      if(genBtn) genBtn.onclick=()=>{ const gen = generateShoppingFromPlan(); state.shopping.items = mergeDistinctTodos(state.shopping.items, gen); renderTodo('shoppingTodo', state.shopping.items, items=>{ state.shopping.items=items; save(); }); save(); toast('Generada desde el plan'); };
    }});
  }
  function generateShoppingFromPlan(){
    const items=[]; const week = getWeekDates(state.weekStart);
    week.forEach(d=>{
      const day=state.planner[fmtDate(d)]||{};
      ['breakfast','lunch','dinner'].forEach(slot=>{
        const it=day[slot]; if(!it) return;
        if(it.type==='recipe'){ const r=state.recipes.find(x=>x.id===it.id); if(r){ r.ingredients.forEach(i=> items.push({text:i,done:false})) } }
        if(it.type==='manual' && it.ingredients){ it.ingredients.forEach(i=> items.push({text:i,done:false})) }
      })
    })
    return dedupeTodos(items);
  }
  function dedupeTodos(arr){ const seen=new Set(); return arr.filter(x=>{const k=(x.text||'').toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true;}); }
  function mergeDistinctTodos(base, add){ const map=new Map(base.map(i=>[(i.text||'').toLowerCase(),i])); add.forEach(i=>{ const k=(i.text||'').toLowerCase(); if(!map.has(k)) map.set(k,i); }); return Array.from(map.values()); }

  // ---------- Planner ----------
  const SLOT_LABELS = { breakfast:'Desayuno', lunch:'Comida', dinner:'Cena' };
  function getWeekDates(start){ return Array.from({length:7}, (_,i)=> addDays(start,i)); }

  function renderPlanner(){
    const wrap = qs('#plannerGrid');
    if(!wrap) return;
    wrap.innerHTML='';
    const week = getWeekDates(state.weekStart||startOfWeek(new Date()));
    qs('#weekLabel') && (qs('#weekLabel').textContent = `${fmtDate(week[0])} · ${fmtDate(week[6])}`);

    // header row
    const headRow = el('div','row');
    headRow.appendChild(headCell(''));
    week.forEach(d=> headRow.appendChild(headCell(d.toLocaleDateString('es-ES',{weekday:'short',day:'2-digit'}))));
    wrap.appendChild(headRow);

    const enabledSlots = Object.entries(state.settings.slots || {}).filter(([,on])=>on).map(([k])=>k);

    enabledSlots.forEach(slot=>{
      const row = el('div','row');
      row.appendChild(slotNameCell(SLOT_LABELS[slot]||slot));
      week.forEach(d=>{
        const dayKey = fmtDate(d);
        const cell = el('div','cell');
        cell.dataset.day=dayKey; cell.dataset.slot=slot;
        hydrateCell(cell);
        row.appendChild(cell);
      });
      wrap.appendChild(row);
    });
  }

  function hydrateCell(cell){
    const dayKey=cell.dataset.day, slot=cell.dataset.slot;
    const entry = (state.planner[dayKey]||{})[slot];
    cell.innerHTML='';
    if(entry){
      cell.classList.add('filled');
      if(entry.type==='recipe'){
        const r = state.recipes.find(x=>x.id===entry.id);
        cell.appendChild(el('div','item-title', r? r.name : '(receta eliminada)'));
        if(r) cell.appendChild(el('div','item-sub', r.desc||''));
      } else {
        cell.appendChild(el('div','item-title', entry.title||'(manual)'));
        if(entry.ingredients?.length) cell.appendChild(el('div','item-sub', entry.ingredients.join(', ')));
      }
    } else {
      cell.classList.remove('filled');
      cell.appendChild(el('div','item-sub','Vacío'));
    }

    // acciones rápidas
    const act = el('div','cell-actions');
    const btnEdit = smallBtn('Editar');
    const btnCopy = smallBtn('Copiar');
    const btnPaste = smallBtn('Pegar');
    const btnDel = smallBtn('Eliminar');
    act.append(btnEdit,btnCopy,btnPaste,btnDel); cell.appendChild(act);

    btnEdit.onclick=()=> openCellEditor(dayKey, slot);
    btnCopy.onclick=()=>{ state.clipboard = clone(entry); toast('Copiado'); };
    btnPaste.onclick=()=>{ if(!state.clipboard) return toast('Portapapeles vacío'); setCell(dayKey,slot,clone(state.clipboard)); };
    btnDel.onclick=()=>{ setCell(dayKey,slot,null); };

    // Drag & drop
    enableDnD(cell);
  }

  function setCell(day,slot,val){
    if(!state.planner[day]) state.planner[day]={};
    if(val) state.planner[day][slot]=val;
    else { if(state.planner[day]) delete state.planner[day][slot]; }
    save();
  }

  function openCellEditor(day, slot){
    const entry = (state.planner[day]||{})[slot] || {};
    const recipesOptions = (state.recipes||[]).map(r=>`<option value="${r.id}">${escape(r.name)}</option>`).join('');
    openModal('Editar celda', `
      <div class="grid">
        <div class="tabs-switch" id="cellModeSwitch">
          <button class="seg ${entry.type!=='manual'?'active':''}" data-mode="recipe">Seleccionar receta</button>
          <button class="seg ${entry.type==='manual'?'active':''}" data-mode="manual">Introducir manual</button>
        </div>
        <div id="recipeMode" class="grid ${entry.type==='manual'?'hidden':''}">
          <label>Receta<select id="cellRecipeSel">${recipesOptions}</select></label>
        </div>
        <div id="manualMode" class="grid ${entry.type==='manual'?'':'hidden'}">
          <label>Título<input class="input" id="manualTitle" value="${escape(entry.title||'')}"/></label>
          <label>Ingredientes (separados por coma)<input class="input" id="manualIngr" value="${escape((entry.ingredients||[]).join(', '))}"/></label>
        </div>
      </div>
    `,{
      ok:'Guardar', onOpen:()=>{
        const switcher = qs('#cellModeSwitch');
        if(switcher) switcher.onclick=(ev)=>{ if(!(ev.target instanceof HTMLButtonElement)) return; qsa('#cellModeSwitch .seg').forEach(b=>b.classList.remove('active')); ev.target.classList.add('active'); const m=ev.target.dataset.mode; qs('#recipeMode').classList.toggle('hidden', m!=='recipe'); qs('#manualMode').classList.toggle('hidden', m!=='manual'); };
        // preset
        if(entry.type==='recipe'){ const sel=qs('#cellRecipeSel'); if(sel) sel.value=entry.id; }
      }, onOk:()=>{
        const activeMode = qs('#cellModeSwitch .seg.active').dataset.mode;
        if(activeMode==='recipe'){
          const idVal = qs('#cellRecipeSel').value; setCell(day,slot,{type:'recipe', id:idVal});
        } else {
          const title = qs('#manualTitle').value.trim();
          const ingredients = qs('#manualIngr').value.split(',').map(s=>s.trim()).filter(Boolean);
          if(!title) return toast('Añade un título');
          setCell(day,slot,{type:'manual', title, ingredients});
        }
      }
    });
  }

  // DnD con mouse + táctil
  function enableDnD(cell){
    let dragging=false, origin=null; let ghost; let currentTarget=null;

    function begin(e){ dragging=true; origin=cell; cell.classList.add('dragging'); ghost=createGhost(cell); document.body.appendChild(ghost); move(e); window.addEventListener(moveEvt(e), move); window.addEventListener(endEvt(e), end, {once:true}); }
    function move(e){ if(!dragging) return; const p=pointer(e); if(ghost){ ghost.style.left=p.x-20+'px'; ghost.style.top=p.y-20+'px'; }
      const elAt = document.elementFromPoint(p.x, p.y); const tgt = elAt ? elAt.closest('.cell') : null;
      if(currentTarget && currentTarget!==tgt) currentTarget.classList.remove('drop-target');
      if(tgt){ tgt.classList.add('drop-target'); currentTarget=tgt; }
    }
    function end(e){ dragging=false; cell.classList.remove('dragging'); ghost?.remove(); currentTarget?.classList.remove('drop-target');
      const p=pointer(e); const elAt = document.elementFromPoint(p.x, p.y); const tgt = elAt ? elAt.closest('.cell') : null;
      if(tgt && tgt!==origin){
        const srcEntry = (state.planner[origin.dataset.day]||{})[origin.dataset.slot];
        setCell(tgt.dataset.day, tgt.dataset.slot, clone(srcEntry));
      }
      window.removeEventListener(moveEvt(e), move);
    }

    cell.addEventListener('mousedown', e=>{ if(e.button!==0) return; begin(e); })
    cell.addEventListener('touchstart', e=>{ begin(e); }, {passive:true})

    function moveEvt(e){ return (e && e.type && e.type.startsWith && e.type.startsWith('touch')) ? 'touchmove' : 'mousemove'; }
    function endEvt(e){ return (e && e.type && e.type.startsWith && e.type.startsWith('touch')) ? 'touchend' : 'mouseup'; }
    function pointer(e){ if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY}; return {x:e.clientX,y:e.clientY}; }
    function createGhost(elm){ const g=document.createElement('div'); g.className='badge'; g.style.position='fixed'; g.style.pointerEvents='none'; g.style.zIndex=200; g.textContent='Mover'; return g; }
  }

  // ---------- Recetas ----------
  const recipesViewBtn = qs('#recipesViewBtn'), albumsViewBtn = qs('#albumsViewBtn');
  if(recipesViewBtn && albumsViewBtn){
    recipesViewBtn.onclick=()=>{ recipesViewBtn.classList.add('active'); albumsViewBtn.classList.remove('active'); qs('#recipesList')?.classList.remove('hidden'); qs('#albumsWrap')?.classList.add('hidden'); };
    albumsViewBtn.onclick=()=>{ recipesViewBtn.classList.remove('active'); albumsViewBtn.classList.add('active'); qs('#recipesList')?.classList.add('hidden'); qs('#albumsWrap')?.classList.remove('hidden'); };
  }
  if(qs('#newRecipeBtn')) qs('#newRecipeBtn').addEventListener('click', ()=> openRecipeEditor());
  if(qs('#recipeSearch')) qs('#recipeSearch').addEventListener('input', renderRecipes);
  if(qs('#recipeSort')) qs('#recipeSort').addEventListener('change', renderRecipes);

  function renderRecipes(){
    const list = qs('#recipesList');
    if(!list) return;
    const term = (qs('#recipeSearch')?.value||'').toLowerCase();
    const sort = qs('#recipeSort')?.value;
    const items = (state.recipes||[]).filter(r=> r.name.toLowerCase().includes(term) || (r.desc||'').toLowerCase().includes(term) );
    items.sort((a,b)=> sort==='recent'? b.createdAt-a.createdAt : sort==='oldest'? a.createdAt-b.createdAt : a.name.localeCompare(b.name,'es'));

    list.innerHTML='';
    items.forEach(r=>{
      const card = el('div','card');
      const img = document.createElement('img'); img.className='thumb'; img.alt=r.name; img.src=r.image||''; card.appendChild(img);
      const c = el('div','content');
      c.appendChild(el('div','title', r.name));
      c.appendChild(el('div','desc', r.desc||''));
      const row = el('div','row');
      const openBtn = btn('Abrir/Editar'); openBtn.style.background='var(--accent)';
      const shareBtn = btn('Compartir', 'ghost');
      const delBtn = btn('Eliminar','ghost'); delBtn.style.color='var(--muted)';
      const saveBtn = btn('Guardar','ghost');
      row.append(openBtn,shareBtn,delBtn,saveBtn); c.appendChild(row); card.appendChild(c);
      openBtn.onclick=()=> openRecipeEditor(r);
      shareBtn.onclick=()=> shareRecipe(r);
      delBtn.onclick=()=> confirm(`¿Eliminar "${r.name}"?`, ()=>{ state.recipes = state.recipes.filter(x=>x.id!==r.id);
        Object.keys(state.planner).forEach(day=>{ ['breakfast','lunch','dinner'].forEach(s=>{ const e=(state.planner[day]||{})[s]; if(e&&e.type==='recipe'&&e.id===r.id){ delete state.planner[day][s]; } }); });
        state.albums.forEach(a=> a.recipeIds = a.recipeIds.filter(id=>id!==r.id));
        save(); toast('Eliminada'); });
      saveBtn.onclick=()=> toast('Guardado ✓');
      list.appendChild(card);
    });

    renderAlbums();
  }

  function openRecipeEditor(recipe){
    const isEdit = !!recipe;
    const data = recipe ? clone(recipe) : { id:id(), name:'', desc:'', image:'', ingredients:[], steps:[], notes:[], createdAt:Date.now() };

    openModal(isEdit? 'Editar receta' : 'Nueva receta', `
      <div class="grid">
        <div class="grid cols-2">
          <label>Nombre<input id="rName" class="input" value="${escape(data.name)}" /></label>
          <label>Descripción<input id="rDesc" class="input" value="${escape(data.desc)}"/></label>
        </div>
        <div class="grid cols-2">
          <label>URL de imagen<input id="rImgUrl" class="input" placeholder="https://..." value="${escape(data.image||'')}"/></label>
          <label class="file-btn">Subir imagen<input id="rImgFile" type="file" accept="image/*"></label>
        </div>
        <div class="grid cols-2">
          <div>
            <h4>Ingredientes</h4>
            <div id="rIngr" class="todo"></div>
            <div class="todo-footer"><input id="ingrInput" class="input" placeholder="Añadir ingrediente"/><button id="addIngr" class="btn">Añadir</button></div>
          </div>
          <div>
            <h4>Preparación</h4>
            <div id="rSteps" class="todo"></div>
            <div class="todo-footer"><input id="stepInput" class="input" placeholder="Añadir paso"/><button id="addStep" class="btn">Añadir</button></div>
          </div>
        </div>
        <div>
          <h4>Observaciones</h4>
          <div id="rNotes" class="todo"></div>
          <div class="todo-footer"><input id="noteInput" class="input" placeholder="Añadir observación"/><button id="addNote" class="btn">Añadir</button></div>
        </div>
        <div class="row wrap">
          <button id="printBtn" class="btn ghost">Imprimir</button>
        </div>
      </div>
    `,{
      ok: isEdit? 'Guardar' : 'Crear', onOpen:()=>{
        renderTodo('rIngr', data.ingredients, arr=> data.ingredients=arr );
        renderTodo('rSteps', data.steps, arr=> data.steps=arr );
        renderTodo('rNotes', data.notes, arr=> data.notes=arr );
        qs('#addIngr').onclick=()=>{ const v=qs('#ingrInput').value.trim(); if(!v) return; data.ingredients.push(v); qs('#ingrInput').value=''; renderTodo('rIngr', data.ingredients, arr=> data.ingredients=arr ); };
        qs('#addStep').onclick=()=>{ const v=qs('#stepInput').value.trim(); if(!v) return; data.steps.push(v); qs('#stepInput').value=''; renderTodo('rSteps', data.steps, arr=> data.steps=arr ); };
        qs('#addNote').onclick=()=>{ const v=qs('#noteInput').value.trim(); if(!v) return; data.notes.push(v); qs('#noteInput').value=''; renderTodo('rNotes', data.notes, arr=> data.notes=arr ); };

        qs('#rImgFile').onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const url = await fileToDataURL(f); data.image=url; qs('#rImgUrl').value=url; };
        qs('#printBtn').onclick=()=>{ window.print(); };
      }, onOk:()=>{
        data.name = qs('#rName').value.trim()||'Sin título';
        data.desc = qs('#rDesc').value.trim();
        data.image = qs('#rImgUrl').value.trim();
        if(!isEdit){ state.recipes.unshift(data); } else {
          const i=state.recipes.findIndex(r=>r.id===data.id); if(i>-1) state.recipes[i]=data;
        }
        save(); toast(isEdit?'Guardado':'Creado');
      }
    });
  }

  // Compartir receta por URL comprimida
  function shareRecipe(r){
    try{
      const payload = { name:r.name, desc:r.desc, image:r.image, ingredients:r.ingredients, steps:r.steps, notes:r.notes };
      const json = JSON.stringify(payload);
      const compressed = LZString.compressToEncodedURIComponent(json);
      const url = `${location.origin}${location.pathname}?import=${compressed}`;
      navigator.clipboard.writeText(url).then(()=> toast('Enlace copiado'));
    }catch(e){ console.warn('share err', e); toast('Error al compartir'); }
  }

  function tryImportFromURL(){
    try{
      const sp = new URLSearchParams(location.search); const token=sp.get('import'); if(!token) return;
      const json = LZString.decompressFromEncodedURIComponent(token); const data = JSON.parse(json);
      const r = { id:id(), name:data.name||'Receta', desc:data.desc||'', image:data.image||'', ingredients:data.ingredients||[], steps:data.steps||[], notes:data.notes||[], createdAt:Date.now() };
      state.recipes.unshift(r); save(); toast('Receta importada');
      sp.delete('import'); history.replaceState({},'', `${location.pathname}`);
    }catch(e){ console.warn('No se pudo importar', e); }
  }

  // Álbumes
  if(qs('#newAlbumBtn')) qs('#newAlbumBtn').addEventListener('click', ()=> openAlbumEditor());
  function renderAlbums(){
    const list = qs('#albumsList');
    if(!list) return;
    list.innerHTML='';
    (state.albums||[]).forEach(a=>{
      const card=el('div','card');
      const img=document.createElement('img'); img.className='thumb'; img.src=a.image||''; img.alt=a.name; card.appendChild(img);
      const c=el('div','content');
      c.appendChild(el('div','title',a.name)); c.appendChild(el('div','desc',a.desc||''));
      const row=el('div','row');
      const openBtn=btn('Abrir'); const editBtn=btn('Editar','ghost'); const delBtn=btn('Eliminar','ghost'); delBtn.style.color='var(--muted)';
      row.append(openBtn,editBtn,delBtn); c.appendChild(row); card.appendChild(c);
      openBtn.onclick=()=> openAlbumViewer(a);
      editBtn.onclick=()=> openAlbumEditor(a);
      delBtn.onclick=()=> confirm(`¿Eliminar álbum "${a.name}"?`, ()=>{ state.albums=state.albums.filter(x=>x.id!==a.id); save(); });
      list.appendChild(card);
    });
  }
  function openAlbumEditor(album){
    const isEdit=!!album; const data = album? clone(album) : { id:id(), name:'', desc:'', image:'', recipeIds:[] };
    const cards = (state.recipes||[]).map(r=>`<label class="row"><input type="checkbox" value="${r.id}" ${data.recipeIds.includes(r.id)?'checked':''}/> ${escape(r.name)}</label>`).join('');
    openModal(isEdit?'Editar álbum':'Nuevo álbum', `
      <div class="grid">
        <label>Nombre<input id="aName" class="input" value="${escape(data.name)}"/></label>
        <label>Descripción<input id="aDesc" class="input" value="${escape(data.desc)}"/></label>
        <label>URL de imagen<input id="aImg" class="input" value="${escape(data.image||'')}" placeholder="https://..."/></label>
        <div class="card pad">
          <b>Recetas</b>
          <div id="aList" class="grid">${cards||'<small class="muted">No hay recetas aún</small>'}</div>
        </div>
      </div>
    `,{ ok:isEdit?'Guardar':'Crear', onOk:()=>{
      data.name=qs('#aName').value.trim()||'Álbum';
      data.desc=qs('#aDesc').value.trim();
      data.image=qs('#aImg').value.trim();
      data.recipeIds = qsa('#aList input:checked').map(i=>i.value);
      if(!isEdit) state.albums.unshift(data); else { const i=state.albums.findIndex(x=>x.id===data.id); if(i>-1) state.albums[i]=data; }
      save();
    }});
  }
  function openAlbumViewer(album){
    const cards = (album.recipeIds||[]).map(id=> state.recipes.find(r=>r.id===id)).filter(Boolean).map(r=>`<div class="card"><img class="thumb" src="${escape(r.image||'')}" alt="${escape(r.name)}"/><div class="content"><div class="title">${escape(r.name)}</div><div class="desc">${escape(r.desc||'')}</div></div></div>`).join('');
    openModal(album.name, `<div class="cards-grid">${cards||'<small class="muted">Vacío</small>'}</div>`, { ok:'Cerrar', showOk:false });
  }

  // ---------- To-Do reutilizable ----------
  function renderTodo(hostId, arr, onChange){
    const host = typeof hostId==='string'? qs('#'+hostId) : hostId; if(!host) return;
    host.innerHTML='';
    arr.forEach((text,idx)=>{
      const item = typeof text==='string'? {text,done:false} : text;
      const row = el('div','todo-item');
      const chk = document.createElement('input'); chk.type='checkbox'; chk.className='chk'; chk.checked=!!item.done; chk.onchange=()=>{ item.done=chk.checked; onChange && onChange(arr); save(); };
      const input = document.createElement('input'); input.type='text'; input.value=item.text; input.oninput=()=>{ item.text=input.value; onChange && onChange(arr); };
      const del = document.createElement('button'); del.className='del'; del.innerHTML='✕'; del.onclick=()=>{ arr.splice(idx,1); renderTodo(host, arr, onChange); onChange && onChange(arr); save(); };
      row.append(chk,input,del); host.appendChild(row);
    });
  }

  // ---------- Modal & Toast ----------
  function openModal(title, bodyHTML, opts={}){
    const m = qs('#modal'); if(!m) return;
    m.classList.add('show'); m.setAttribute('aria-hidden','false');
    qs('#modalTitle').textContent=title; qs('#modalBody').innerHTML=bodyHTML;
    const okBtn = qs('#modalOkBtn');
    const showOk = opts.showOk!==false; qs('#modalOkBtn').style.display = showOk?'':'none';
    const closeEls = m.querySelectorAll('[data-close]');
    closeEls.forEach(el=> el.onclick=closeModal);
    okBtn.onclick = ()=>{ if(opts.onOk) opts.onOk(); closeModal(); };
    opts.onOpen && opts.onOpen();
  }
  function confirm(msg, onYes){ openModal('Confirmar', `<p>${escape(msg)}</p>`, { ok:'Aceptar', onOk:onYes }) }
  function closeModal(){ const m = qs('#modal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); qs('#modalBody').innerHTML=''; }
  let toastTimer;
  function toast(msg){
    const t = qs('#toast'); if(!t) { console.log('toast:',msg); return; }
    t.textContent = msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=> t.classList.remove('show'), 1600);
  }

  // ---------- Utils ----------
  function cloneDeep(o){ return o? JSON.parse(JSON.stringify(o)) : o; }

  // ---------- Render raíz ----------
  function render(){
    try{
      // tema
      setAccent(state.settings.accent||'#6c5ce7'); setDark(!!state.settings.dark);
      // header
      qs('#headerTitle') && (qs('#headerTitle').textContent = state.titlePerView[state.activeTab]||'');
      // tabs UI
      qsa('.tab-item').forEach(b=> b.classList.toggle('active', b.dataset.tab===state.activeTab));
      qsa('.view').forEach(v=> v.classList.remove('active')); const activeView = qs('#view-'+state.activeTab); if(activeView) activeView.classList.add('active');
      // ajustes UI (inputs)
      if(qs('#accentPicker')) qs('#accentPicker').value = state.settings.accent||'#6c5ce7';
      if(qs('#darkToggle')) qs('#darkToggle').checked = !!state.settings.dark;
      if(qs('#breakfastToggle')) qs('#breakfastToggle').checked = !!state.settings.slots.breakfast;
      if(qs('#lunchToggle')) qs('#lunchToggle').checked = !!state.settings.slots.lunch;
      if(qs('#dinnerToggle')) qs('#dinnerToggle').checked = !!state.settings.slots.dinner;
      // planner & recetas
      renderPlanner();
      renderRecipes();
      // login state
      if(qs('#loginState')) qs('#loginState').textContent = state.account.email? `Sesión iniciada: ${state.account.email}` : 'Sin sesión';
    }catch(e){
      console.error('render root err', e);
    }
  }

  // ---------- Init ----------
  try{
    load();
    tryImportFromURL();
    scheduleRender();
  }catch(e){
    console.error('init err', e);
  }
})();
</script>
</body>
</html>
