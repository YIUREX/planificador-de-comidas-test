<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificador de Comidas</title>
<style>
  :root{
    --bg: #f7f7fb;
    --fg: #0f1020;
    --muted:#7a7d91;
    --card:#ffffff;
    --primary:#6c7cff;
    --primary-weak:#e8ebff;
    --ring: rgba(108,124,255,.4);
    --shadow: 0 10px 30px rgba(0,0,0,.06);
    --radius: 18px;
  }
  /* Dark mode */
  :root.dark{
    --bg: #0e1116;
    --fg: #e9eaf0;
    --muted:#9aa3b2;
    --card:#121721;
    --primary:#8ea0ff;
    --primary-weak:#20263a;
    --ring: rgba(142,160,255,.45);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg);
    color: var(--fg);
    line-height:1.35;
  }

  /* Layout */
  .app{
    min-height:100dvh;
    display:grid;
    grid-template-rows: auto 1fr auto;
    gap:14px;
    padding:16px 16px 86px; /* space for bottom nav */
  }
  header{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .title{
    font-size: clamp(20px, 3.5vw, 28px);
    font-weight:800;
    letter-spacing:.2px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 14px;
    background: var(--card);
    border: 1px solid color-mix(in srgb, var(--fg) 8%, transparent);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    outline: 2px solid transparent;
  }
  .title[contenteditable="true"]:focus{
    outline: 3px solid var(--ring);
  }
  .subtitle{
    color: var(--muted);
    font-size: 13px;
    margin-left: 2px;
  }

  /* Tabs container */
  main{ max-width: 1100px; width:100%; margin: 0 auto; display:grid; gap:16px;}
  section.view{ display:none; }
  section.view.active{ display:block; }

  /* Planner */
  .planner-card{
    background: var(--card);
    border:1px solid color-mix(in srgb, var(--fg) 8%, transparent);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .planner-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 14px; border-bottom:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
  }
  .week-nav{
    display:flex; align-items:center; gap:8px;
  }
  .btn{
    appearance:none; border:0; cursor:pointer;
    background: var(--primary);
    color:white; padding:10px 14px; border-radius:14px; font-weight:700;
    box-shadow: 0 6px 18px color-mix(in srgb, var(--primary) 35%, transparent);
    transition:.2s transform ease, .2s opacity ease, .2s background ease;
  }
  .btn:hover{ transform: translateY(-1px) }
  .btn:active{ transform: translateY(0) scale(.98) }
  .btn.ghost{
    background: var(--primary-weak);
    color: var(--primary);
    box-shadow:none;
  }
  .btn.icon{
    width:36px; height:36px; padding:0;
    display:inline-grid; place-items:center; border-radius:12px;
  }
  .btn.small{ padding:8px 12px; border-radius:12px; font-size:13px }

  .week-label{
    font-weight:800; letter-spacing:.3px;
  }
  .helper{ color:var(--muted); font-size:12px }

  .planner-grid{
    width:100%; overflow:auto; padding:10px 10px 14px;
  }
  table.grid{
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    min-width: 720px;
    background: transparent;
  }
  .grid thead th{
    position:sticky; top:0; background: var(--card);
    z-index:2;
    font-size:13px; color: var(--muted); text-align:left; padding:10px 12px;
    border-bottom:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
  }
  .meal-col{ width:140px; }
  .grid tbody td, .grid thead th{
    border-right:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
  }
  .grid thead th:last-child, .grid tbody td:last-child{ border-right:0 }
  .grid tbody tr{
    border-bottom:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
  }
  .grid tbody tr:last-child{ border-bottom:0 }
  .slot{
    padding:8px;
    vertical-align:top;
  }
  .cell{
    border:1px dashed color-mix(in srgb, var(--fg) 12%, transparent);
    border-radius:12px;
    padding:10px;
    background: linear-gradient(180deg, color-mix(in srgb, var(--primary-weak) 0%, transparent), color-mix(in srgb, var(--primary-weak) 10%, transparent));
    min-height:70px;
    display:grid; grid-template-rows:auto 1fr; gap:6px;
    cursor:pointer;
    transition:.15s border-color ease, .15s background ease, .15s transform ease;
  }
  .cell:hover{ border-color: var(--primary); transform: translateY(-1px) }
  .cell .name{ font-weight:700; font-size:14px }
  .cell .meta{ font-size:12px; color:var(--muted) }

  .legend{
    display:flex; align-items:center; gap:10px; padding:10px 14px; color:var(--muted); border-top:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
  }

  .toolbar{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; padding:10px 14px;
    border-top:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
  }

  /* Bottom nav */
  .tabs{
    position:fixed; inset:auto 0 10px 0;
    display:flex; gap:10px; justify-content:space-evenly;
    padding:10px; z-index:50;
  }
  .tab-btn{
    flex:1; display:flex; align-items:center; justify-content:center; gap:8px;
    padding:12px; border-radius:16px; font-weight:700; font-size:14px;
    background: var(--card);
    color: var(--muted);
    border:1px solid color-mix(in srgb, var(--fg) 8%, transparent);
    box-shadow: var(--shadow);
    cursor:pointer; transition:.2s transform ease, .2s color ease, .2s background ease;
  }
  .tab-btn.active{ color: var(--primary); background: color-mix(in srgb, var(--primary-weak) 50%, var(--card)); }
  .tab-btn:active{ transform: translateY(1px) }

  /* Recipes */
  .recipes-wrap{
    display:grid; gap:14px;
  }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .input, textarea, select{
    width:100%; padding:12px 12px; border-radius:12px; border:1px solid color-mix(in srgb, var(--fg) 12%, transparent);
    background: var(--card); color: var(--fg); outline: none; box-shadow: var(--shadow);
  }
  .input:focus, textarea:focus, select:focus{ border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring); }
  textarea{ min-height:90px; resize:vertical }
  .grid-cards{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px }
  .card{
    background: var(--card);
    border:1px solid color-mix(in srgb, var(--fg) 8%, transparent);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
    display:grid; grid-template-rows: 150px 1fr auto; 
  }
  .thumb{ width:100%; height:100%; object-fit:cover; background: #e3e7ef}
  .card-body{ padding:12px }
  .card-title{ font-weight:800 }
  .card-meta{ color:var(--muted); font-size:13px }
  .card-actions{ display:flex; gap:8px; padding:10px; border-top:1px dashed color-mix(in srgb, var(--fg) 10%, transparent) }

  /* To-do (shopping) */
  .todo{
    background: var(--card);
    border:1px solid color-mix(in srgb, var(--fg) 8%, transparent);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .todo-head{ padding:12px 14px; border-bottom:1px dashed color-mix(in srgb, var(--fg) 10%, transparent); display:flex; gap:8px; align-items:center }
  .todo-list{ padding:10px 10px 14px; display:grid; gap:8px }
  .todo-item{
    display:grid; grid-template-columns: 28px 1fr auto; gap:8px; align-items:center;
    padding:8px 10px; border-radius:12px; border:1px dashed color-mix(in srgb, var(--fg) 10%, transparent);
    background: linear-gradient(180deg, color-mix(in srgb, var(--primary-weak) 0%, transparent), color-mix(in srgb, var(--primary-weak) 10%, transparent));
  }
  .todo-item input[type="text"]{
    border:0; background:transparent; outline:none; color:var(--fg); font-size:14px
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    background: var(--primary-weak); color: var(--primary);
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
  }

  /* Settings */
  .settings{ display:grid; gap:14px }
  .switch{
    display:flex; align-items:center; justify-content:space-between; padding:12px 14px;
    background: var(--card); border:1px solid color-mix(in srgb, var(--fg) 8%, transparent);
    border-radius: var(--radius); box-shadow: var(--shadow);
  }
  .switch label{ font-weight:700 }
  .switch .desc{ color:var(--muted); font-size:12px }

  /* Dialogs (modals) */
  dialog{
    border:0; border-radius:20px; padding:0; width:min(720px, 92vw); background: var(--card);
    color: var(--fg); box-shadow: var(--shadow);
  }
  dialog::backdrop{ background: rgba(0,0,0,.35) }
  .modal{
    display:grid; grid-template-rows: auto 1fr auto; max-height:80vh;
  }
  .modal-head{ padding:14px 16px; border-bottom:1px dashed color-mix(in srgb, var(--fg) 10%, transparent); display:flex; align-items:center; justify-content:space-between; gap:8px }
  .modal-body{ padding:14px 16px; overflow:auto; display:grid; gap:12px }
  .modal-actions{ padding:12px 16px; border-top:1px dashed color-mix(in srgb, var(--fg) 10%, transparent); display:flex; justify-content:flex-end; gap:8px }

  /* Tiny icons (emoji for zero-deps) */
  .i{ font-style:normal }

  /* Responsive tweaks */
  @media (max-width: 720px){
    .meal-col{ width:120px }
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="title" id="banner" contenteditable="true" spellcheck="false">Planificador semanal</div>
      <div class="subtitle">toca para editar</div>
    </header>

    <main>
      <!-- PLANNER -->
      <section id="view-planner" class="view active">
        <div class="planner-card">
          <div class="planner-head">
            <div class="week-nav">
              <button class="btn icon ghost" id="prevWeek" title="Semana anterior" aria-label="Semana anterior">‚ü®</button>
              <div>
                <div class="week-label" id="weekLabel">Semana</div>
                <div class="helper" id="weekRange"></div>
              </div>
              <button class="btn icon ghost" id="nextWeek" title="Semana siguiente" aria-label="Semana siguiente">‚ü©</button>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn small ghost" id="btnToday">Hoy</button>
              <button class="btn small" id="btnShopping">Lista de la compra</button>
            </div>
          </div>
          <div class="planner-grid">
            <table class="grid" id="plannerTable" aria-label="Planificaci√≥n semanal">
              <!-- generated -->
            </table>
          </div>
          <div class="legend">
            <span class="chip">Consejo</span>
            Toca una celda para <b>a√±adir</b>, <b>copiar</b>, <b>pegar</b> o <b>borrar</b>.
          </div>
          <div class="toolbar">
            <div class="helper">Todo se guarda autom√°ticamente en tu dispositivo.</div>
            <div class="row">
              <button class="btn small ghost" id="btnClearWeek">Vaciar semana</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RECIPES -->
      <section id="view-recipes" class="view">
        <div class="recipes-wrap">
          <div class="row" style="align-items:flex-start">
            <input class="input" id="recipeSearch" placeholder="Buscar receta por nombre o ingrediente‚Ä¶" />
            <button class="btn" id="btnNewRecipe">Nueva receta</button>
          </div>
          <div class="grid-cards" id="recipesList"></div>
        </div>
      </section>

      <!-- CHEF -->
      <section id="view-chef" class="view">
        <div class="planner-card" style="padding:24px">
          <h2 style="margin:0 0 6px">Chef (IA)</h2>
          <p class="helper" style="margin:0 0 14px">Pr√≥ximamente</p>
          <div style="display:grid; gap:10px">
            <div class="switch">
              <div>
                <label>Integraci√≥n con IA</label>
                <div class="desc">Aqu√≠ podr√°s generar men√∫s y ajustar calor√≠as autom√°ticamente.</div>
              </div>
              <button class="btn ghost">Pr√≥ximamente</button>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="view">
        <div class="settings">
          <div class="switch">
            <div>
              <label>Color principal</label>
              <div class="desc">Personaliza el acento de la app.</div>
            </div>
            <input type="color" id="colorPicker" aria-label="Elegir color principal" />
          </div>

          <div class="switch">
            <div>
              <label>Modo oscuro</label>
              <div class="desc">Activa/desactiva el tema oscuro.</div>
            </div>
            <label class="row" style="align-items:center; gap:10px">
              <input type="checkbox" id="toggleDark" />
              <span class="chip">Alternar</span>
            </label>
          </div>

          <div class="switch">
            <div>
              <label>Franjas de comidas</label>
              <div class="desc">Muestra u oculta desayunos, comidas o cenas.</div>
            </div>
            <div class="row" style="gap:10px">
              <label class="chip"><input type="checkbox" id="showBreakfast" checked style="accent-color: var(--primary)"/> Desayuno</label>
              <label class="chip"><input type="checkbox" id="showLunch" checked style="accent-color: var(--primary)"/> Comida</label>
              <label class="chip"><input type="checkbox" id="showDinner" checked style="accent-color: var(--primary)"/> Cena</label>
            </div>
          </div>

          <div class="switch">
            <div>
              <label>Gesti√≥n versi√≥n Pro</label>
              <div class="desc">Suscripciones, recuperaci√≥n y ventajas.</div>
            </div>
            <button class="btn ghost" id="btnPro">Gesti√≥n versi√≥n Pro</button>
          </div>
        </div>
      </section>
    </main>

    <!-- TABS -->
    <nav class="tabs" aria-label="Navegaci√≥n inferior">
      <button class="tab-btn active" data-tab="planner">üóìÔ∏è Planificaci√≥n</button>
      <button class="tab-btn" data-tab="recipes">üìö Recetas</button>
      <button class="tab-btn" data-tab="chef">üë®‚Äçüç≥ Chef</button>
      <button class="tab-btn" data-tab="settings">‚öôÔ∏è Ajustes</button>
    </nav>
  </div>

  <!-- MODALS -->
  <!-- Planner cell modal -->
  <dialog id="cellDialog">
    <div class="modal">
      <div class="modal-head">
        <strong id="cellDialogTitle">Editar comida</strong>
        <button class="btn icon ghost" data-close="cellDialog" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modal-body" id="cellDialogBody">
        <div id="cellCurrent" class="helper">Sin contenido</div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button class="btn" id="cellSelectRecipe">Seleccionar receta</button>
          <button class="btn ghost" id="cellAddManual">A√±adir manualmente</button>
          <button class="btn ghost" id="cellCopy">Copiar</button>
          <button class="btn ghost" id="cellPaste">Pegar</button>
          <button class="btn ghost" id="cellClear">Borrar</button>
        </div>
        <!-- Manual form (hidden initially) -->
        <form id="manualForm" style="display:none; gap:10px" class="recipes-wrap">
          <input class="input" id="manualName" placeholder="Nombre del plato" required />
          <textarea id="manualIngr" placeholder="Ingredientes (separados por coma)"></textarea>
          <div class="row">
            <button type="submit" class="btn">Guardar</button>
            <button type="button" class="btn ghost" id="manualCancel">Cancelar</button>
          </div>
        </form>
      </div>
      <div class="modal-actions">
        <button class="btn" data-close="cellDialog">Listo</button>
      </div>
    </div>
  </dialog>

  <!-- Recipe picker modal -->
  <dialog id="pickerDialog">
    <div class="modal">
      <div class="modal-head">
        <strong>Seleccionar receta</strong>
        <button class="btn icon ghost" data-close="pickerDialog" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modal-body" style="display:grid; gap:10px">
        <input class="input" id="pickerSearch" placeholder="Buscar‚Ä¶" />
        <div class="grid-cards" id="pickerList"></div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" data-close="pickerDialog">Cancelar</button>
      </div>
    </div>
  </dialog>

  <!-- New/Edit recipe modal -->
  <dialog id="recipeDialog">
    <div class="modal">
      <div class="modal-head">
        <strong id="recipeDialogTitle">Nueva receta</strong>
        <button class="btn icon ghost" data-close="recipeDialog" aria-label="Cerrar">‚úï</button>
      </div>
      <form class="modal-body" id="recipeForm">
        <input class="input" id="rName" placeholder="Nombre" required />
        <textarea id="rDesc" placeholder="Descripci√≥n"></textarea>
        <textarea id="rIngr" placeholder="Ingredientes (uno por l√≠nea o separados por coma)"></textarea>
        <div class="row" style="width:100%">
          <input class="input" id="rPhotoUrl" placeholder="URL de foto (opcional)" />
          <label class="btn ghost" style="white-space:nowrap; cursor:pointer">
            Subir imagen
            <input type="file" id="rPhotoFile" accept="image/*" style="display:none" />
          </label>
        </div>
        <input type="hidden" id="rId" />
      </form>
      <div class="modal-actions">
        <button class="btn ghost" data-close="recipeDialog">Cancelar</button>
        <button class="btn" id="saveRecipe">Guardar</button>
      </div>
    </div>
  </dialog>

  <!-- Shopping list modal -->
  <dialog id="shoppingDialog">
    <div class="modal">
      <div class="modal-head">
        <strong>Lista de la compra</strong>
        <button class="btn icon ghost" data-close="shoppingDialog" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="todo">
          <div class="todo-head">
            <input class="input" id="newItemInput" placeholder="A√±adir art√≠culo‚Ä¶" />
            <button class="btn" id="addItemBtn">A√±adir</button>
            <button class="btn ghost" id="regenFromMealsBtn" title="Regenerar a partir de la semana">üõí Generar</button>
            <button class="btn ghost" id="clearDoneBtn" title="Eliminar marcados">üßπ Limpiar</button>
          </div>
          <div class="todo-list" id="todoList"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" data-close="shoppingDialog">Cerrar</button>
      </div>
    </div>
  </dialog>

  <!-- Tiny toast -->
  <dialog id="toast" style="padding:10px 14px; border-radius:12px; background: var(--card); border:1px solid color-mix(in srgb, var(--fg) 10%, transparent)"></dialog>

<script>
(() => {
  /* -------------------------- Utilities & Storage -------------------------- */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const storage = {
    get(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch{ return fallback }
    },
    set(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
  };
  const uid = () => Math.random().toString(36).slice(2, 10);
  const todayISO = () => new Date().toISOString().slice(0,10);

  /* ------------------------------ Global State ----------------------------- */
  const state = {
    weekOffset: 0,            // 0 = current week
    clipboard: null,          // {type:'recipe'|'manual', payload:{}}
    settings: storage.get('settings', {
      dark: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) || false,
      primary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6c7cff',
      show: { breakfast:true, lunch:true, dinner:true }
    }),
    banner: storage.get('banner', 'Planificador semanal'),
    recipes: storage.get('recipes', sampleRecipes()),
    planner: storage.get('planner', {}), // { [weekKey]: { [dayKey]: { breakfast|lunch|dinner: Entry|null } } }
    shopping: storage.get('shopping', {}) // { [weekKey]: [ {text, done} ] }
  };

  /* ----------------------------- Sample Content ---------------------------- */
  function sampleRecipes(){
    return [
      { id: uid(), name:'Avena con fruta', desc:'Avena r√°pida con pl√°tano y miel.', ingredients:['avena','leche','pl√°tano','miel','canela'], photo:'' },
      { id: uid(), name:'Ensalada mediterr√°nea', desc:'Tomate, pepino, aceitunas y feta.', ingredients:['tomate','pepino','aceitunas','queso feta','aceite de oliva'], photo:'' },
      { id: uid(), name:'Pasta al pesto', desc:'Pasta con pesto de albahaca.', ingredients:['pasta','albahaca','pi√±ones','ajo','parmesano','aceite de oliva'], photo:'' }
    ];
  }

  /* ------------------------------ Theme Apply ------------------------------ */
  function applySettings(){
    document.documentElement.style.setProperty('--primary', state.settings.primary);
    document.documentElement.classList.toggle('dark', !!state.settings.dark);
    $('#toggleDark').checked = !!state.settings.dark;
    $('#colorPicker').value = toHex(state.settings.primary) || '#6c7cff';
    $('#showBreakfast').checked = !!state.settings.show.breakfast;
    $('#showLunch').checked = !!state.settings.show.lunch;
    $('#showDinner').checked = !!state.settings.show.dinner;
  }
  function toHex(c){
    const ctx = document.createElement('canvas').getContext('2d');
    ctx.fillStyle = c; // browser normalizes any valid color string to rgb(a)
    const rgb = ctx.fillStyle.match(/\d+/g);
    if(!rgb) return null;
    const [r,g,b] = rgb.map(n => parseInt(n,10));
    const hex = '#' + [r,g,b].map(n => n.toString(16).padStart(2,'0')).join('');
    return hex;
  }

  /* ------------------------------ Tabs Switch ------------------------------ */
  const views = {
    planner: $('#view-planner'),
    recipes: $('#view-recipes'),
    chef: $('#view-chef'),
    settings: $('#view-settings')
  };
  $$('.tabs .tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tabs .tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      Object.values(views).forEach(v=>v.classList.remove('active'));
      views[tab].classList.add('active');
      if(tab==='recipes') renderRecipes();
      if(tab==='planner') renderPlanner();
    });
  });

  /* ------------------------------- Banner edit ----------------------------- */
  const bannerEl = $('#banner');
  bannerEl.textContent = state.banner;
  bannerEl.addEventListener('input', ()=>{
    state.banner = bannerEl.textContent.trim() || 'Planificador semanal';
    storage.set('banner', state.banner);
  });

  /* ----------------------------- Week Helpers ------------------------------ */
  // Get Monday of week (based on current date + offset weeks)
  function getWeekStart(offset=0){
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const day = d.getDay(); // 0 Sun - 6 Sat
    const diffToMonday = (day===0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diffToMonday + offset*7);
    d.setHours(0,0,0,0);
    return d;
  }
  const DAY_NAMES = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
  function formatDate(d){ return d.toISOString().slice(0,10); }
  function weekKeyOf(date){ // YYYY-Www (ISO-ish)
    const tmp = new Date(date.getTime());
    tmp.setHours(0,0,0,0);
    // Thursday in current week decides the week number per ISO-8601
    tmp.setDate(tmp.getDate() + 3 - ((tmp.getDay()+6)%7));
    const week1 = new Date(tmp.getFullYear(),0,4);
    const weekNo = 1 + Math.round(((tmp.getTime() - week1.getTime())/86400000 - 3 + ((week1.getDay()+6)%7))/7);
    return `${tmp.getFullYear()}-W${String(weekNo).padStart(2,'0')}`;
  }

  /* ------------------------------ Planner Render --------------------------- */
  const MEALS = ['breakfast','lunch','dinner'];
  const MEAL_LABEL = { breakfast:'Desayuno', lunch:'Comida', dinner:'Cena' };

  function ensureWeekData(weekKey){
    if(!state.planner[weekKey]) state.planner[weekKey] = {};
    const monday = getWeekStart(state.weekOffset);
    for(let i=0;i<7;i++){
      const date = new Date(monday); date.setDate(date.getDate()+i);
      const dayKey = formatDate(date);
      if(!state.planner[weekKey][dayKey]) state.planner[weekKey][dayKey] = { breakfast:null, lunch:null, dinner:null };
    }
    storage.set('planner', state.planner);
  }

  function renderPlanner(){
    const start = getWeekStart(state.weekOffset);
    const end = new Date(start); end.setDate(end.getDate()+6);
    const weekKey = weekKeyOf(start);
    ensureWeekData(weekKey);

    $('#weekLabel').textContent = `Semana ${weekKey.split('W')[1]}`;
    $('#weekRange').textContent = `${start.toLocaleDateString('es-ES', { day:'2-digit', month:'short'})} ‚Äî ${end.toLocaleDateString('es-ES', { day:'2-digit', month:'short'})}`;

    // Build table
    const show = state.settings.show;
    const activeMeals = MEALS.filter(m => show[m]);
    const thead = `<thead><tr>
      <th class="meal-col">Franja</th>
      ${[...Array(7)].map((_,i)=>{
        const d = new Date(start); d.setDate(d.getDate()+i);
        const isToday = formatDate(d)===todayISO();
        return `<th>${DAY_NAMES[i]}<br><span class="helper" style="${isToday?'color:var(--primary); font-weight:800':''}">${d.toLocaleDateString('es-ES',{ day:'2-digit', month:'short'})}${isToday?' ‚Ä¢ hoy':''}</span></th>`;
      }).join('')}
    </tr></thead>`;

    const tbodyRows = activeMeals.map(meal=>{
      const cells = [...Array(7)].map((_,i)=>{
        const d = new Date(start); d.setDate(d.getDate()+i);
        const dayKey = formatDate(d);
        const entry = state.planner[weekKey][dayKey][meal];
        const { name, meta } = displayForEntry(entry);
        return `<td class="slot">
          <div class="cell" data-day="${dayKey}" data-meal="${meal}" title="Toca para editar">
            <div class="name">${name || '<span class="helper">‚Äî vac√≠o ‚Äî</span>'}</div>
            <div class="meta">${meta || ''}</div>
          </div>
        </td>`;
      }).join('');
      return `<tr><th scope="row">${MEAL_LABEL[meal]}</th>${cells}</tr>`;
    }).join('');

    $('#plannerTable').innerHTML = thead + `<tbody>${tbodyRows}</tbody>`;

    // bind cell clicks
    $$('#plannerTable .cell').forEach(cell=>{
      cell.addEventListener('click', ()=> openCellDialog(cell.dataset.day, cell.dataset.meal));
    });
  }

  function displayForEntry(entry){
    if(!entry) return { name:'', meta:'' };
    if(entry.type==='recipe'){
      const r = state.recipes.find(x=>x.id===entry.id);
      if(r) return { name:r.name, meta:r.ingredients.slice(0,4).join(', ') + (r.ingredients.length>4?'‚Ä¶':'') };
      return { name:'(receta eliminada)', meta:'' };
    }else if(entry.type==='manual'){
      return { name: entry.name, meta: (entry.ingredients||[]).join(', ') };
    }
    return { name:'', meta:'' };
  }

  /* --------------------------- Planner interactions ------------------------ */
  $('#prevWeek').addEventListener('click', ()=>{ state.weekOffset--; renderPlanner(); });
  $('#nextWeek').addEventListener('click', ()=>{ state.weekOffset++; renderPlanner(); });
  $('#btnToday').addEventListener('click', ()=>{ state.weekOffset=0; renderPlanner(); });
  $('#btnClearWeek').addEventListener('click', ()=>{
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    if(!state.planner[wk]) return;
    Object.keys(state.planner[wk]).forEach(day=>{
      MEALS.forEach(m=> state.planner[wk][day][m] = null);
    });
    storage.set('planner', state.planner);
    renderPlanner();
    toast('Semana vaciada');
  });

  /* ------------------------------ Cell dialog ------------------------------ */
  let currentCell = { day:null, meal:null };
  function openCellDialog(day, meal){
    currentCell = { day, meal };
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    const entry = state.planner[wk][day][meal];
    const { name, meta } = displayForEntry(entry);
    $('#cellDialogTitle').textContent = `${MEAL_LABEL[meal]} ‚Ä¢ ${new Date(day).toLocaleDateString('es-ES',{ weekday:'short', day:'2-digit', month:'short'})}`;
    $('#cellCurrent').innerHTML = entry ? `<strong>${name}</strong><br><span class="helper">${meta}</span>` : '<span class="helper">Sin contenido</span>';
    $('#manualForm').style.display = 'none';
    $('#cellPaste').disabled = !state.clipboard;

    openModal('cellDialog');
  }
  $('#cellSelectRecipe').addEventListener('click', ()=>{
    renderPicker();
    openModal('pickerDialog');
  });
  $('#cellAddManual').addEventListener('click', ()=>{
    $('#manualName').value=''; $('#manualIngr').value='';
    $('#manualForm').style.display = 'grid';
  });
  $('#manualCancel').addEventListener('click', ()=> $('#manualForm').style.display='none');
  $('#manualForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = $('#manualName').value.trim();
    const ing = $('#manualIngr').value.split(/,|\n/).map(s=>s.trim()).filter(Boolean);
    if(!name) return;
    setCurrentCell({ type:'manual', name, ingredients: ing });
    closeModal('cellDialog');
  });
  $('#cellCopy').addEventListener('click', ()=>{
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    const entry = state.planner[wk][currentCell.day][currentCell.meal];
    if(!entry){ toast('Nada que copiar'); return; }
    state.clipboard = JSON.parse(JSON.stringify(entry));
    toast('Copiado ‚úì');
  });
  $('#cellPaste').addEventListener('click', ()=>{
    if(!state.clipboard){ toast('Portapapeles vac√≠o'); return; }
    setCurrentCell(state.clipboard);
    closeModal('cellDialog');
  });
  $('#cellClear').addEventListener('click', ()=>{
    setCurrentCell(null);
    closeModal('cellDialog');
  });

  function setCurrentCell(entry){
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    ensureWeekData(wk);
    state.planner[wk][currentCell.day][currentCell.meal] = entry ? JSON.parse(JSON.stringify(entry)) : null;
    storage.set('planner', state.planner);
    renderPlanner();
    toast(entry ? 'Guardado' : 'Eliminado');
  }

  /* ------------------------------ Picker modal ----------------------------- */
  function renderPicker(){
    const list = $('#pickerList'); list.innerHTML='';
    const q = ($('#pickerSearch').value||'').toLowerCase();
    const results = state.recipes.filter(r=>{
      const haystack = (r.name+' '+r.desc+' '+(r.ingredients||[]).join(' ')).toLowerCase();
      return haystack.includes(q);
    });
    for(const r of results){
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.className='thumb'; img.alt=r.name; img.src = r.photo || placeholderFor(r.name);
      const body = document.createElement('div'); body.className='card-body';
      body.innerHTML = `<div class="card-title">${r.name}</div><div class="card-meta">${r.ingredients.slice(0,4).join(', ')}${r.ingredients.length>4?'‚Ä¶':''}</div>`;
      const actions = document.createElement('div'); actions.className='card-actions';
      const choose = document.createElement('button'); choose.className='btn'; choose.textContent='Elegir';
      choose.addEventListener('click', ()=>{
        setCurrentCell({ type:'recipe', id:r.id });
        closeModal('pickerDialog'); closeModal('cellDialog');
      });
      const share = document.createElement('button'); share.className='btn ghost'; share.textContent='Compartir';
      share.addEventListener('click', ()=> shareRecipe(r));
      actions.appendChild(choose); actions.appendChild(share);
      card.appendChild(img); card.appendChild(body); card.appendChild(actions);
      list.appendChild(card);
    }
  }
  $('#pickerSearch').addEventListener('input', renderPicker);

  /* -------------------------------- Recipes UI ----------------------------- */
  function renderRecipes(){
    const wrap = $('#recipesList'); wrap.innerHTML='';
    const q = ($('#recipeSearch').value||'').toLowerCase();
    const filtered = state.recipes.filter(r=>{
      const hay = (r.name+' '+r.desc+' '+(r.ingredients||[]).join(' ')).toLowerCase();
      return hay.includes(q);
    });
    if(filtered.length===0){
      wrap.innerHTML = `<div class="helper" style="padding:14px">No hay recetas. Crea la primera con ‚ÄúNueva receta‚Äù.</div>`;
      return;
    }
    for(const r of filtered){
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.className='thumb'; img.alt=r.name; img.loading='lazy';
      img.src = r.photo || placeholderFor(r.name);
      const body = document.createElement('div'); body.className='card-body';
      body.innerHTML = `<div class="card-title">${r.name}</div><div class="card-meta">${r.desc||'Sin descripci√≥n'}</div>`;
      const actions = document.createElement('div'); actions.className='card-actions';
      const useBtn = document.createElement('button'); useBtn.className='btn'; useBtn.textContent='Usar en semana';
      useBtn.addEventListener('click', ()=>{
        // Quick-add: put into first empty cell (today forward)
        quickAssignRecipe(r.id);
      });
      const shareBtn = document.createElement('button'); shareBtn.className='btn ghost'; shareBtn.textContent='Compartir';
      shareBtn.addEventListener('click', ()=> shareRecipe(r));
      const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.textContent='Editar';
      editBtn.addEventListener('click', ()=> openRecipeDialog(r));
      const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='Eliminar';
      delBtn.addEventListener('click', ()=> deleteRecipe(r.id));
      actions.append(useBtn, shareBtn, editBtn, delBtn);
      card.append(img, body, actions);
      wrap.appendChild(card);
    }
  }
  $('#recipeSearch').addEventListener('input', renderRecipes);
  $('#btnNewRecipe').addEventListener('click', ()=> openRecipeDialog());

  function openRecipeDialog(recipe){
    $('#recipeDialogTitle').textContent = recipe ? 'Editar receta' : 'Nueva receta';
    $('#rId').value = recipe ? recipe.id : '';
    $('#rName').value = recipe ? recipe.name : '';
    $('#rDesc').value = recipe ? recipe.desc : '';
    $('#rIngr').value = recipe ? (recipe.ingredients||[]).join('\n') : '';
    $('#rPhotoUrl').value = recipe ? (recipe.photo || '') : '';
    $('#rPhotoFile').value = '';
    openModal('recipeDialog');
  }
  $('#rPhotoFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const dataUrl = await fileToDataURL(file);
    $('#rPhotoUrl').value = dataUrl;
  });
  async function fileToDataURL(file){
    return new Promise(res=>{
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.readAsDataURL(file);
    });
  }
  $('#saveRecipe').addEventListener('click', (e)=>{
    e.preventDefault();
    const id = $('#rId').value || uid();
    const name = $('#rName').value.trim();
    if(!name){ toast('Pon un nombre'); return; }
    const desc = $('#rDesc').value.trim();
    const ingredients = $('#rIngr').value.split(/,|\n/).map(s=>s.trim()).filter(Boolean);
    const photo = $('#rPhotoUrl').value.trim();
    const idx = state.recipes.findIndex(r=>r.id===id);
    const rec = { id, name, desc, ingredients, photo };
    if(idx>=0) state.recipes[idx]=rec; else state.recipes.unshift(rec);
    storage.set('recipes', state.recipes);
    closeModal('recipeDialog');
    renderRecipes();
    toast('Receta guardada');
  });
  function deleteRecipe(id){
    state.recipes = state.recipes.filter(r=>r.id!==id);
    storage.set('recipes', state.recipes);
    renderRecipes();
    toast('Receta eliminada');
  }
  function quickAssignRecipe(recipeId){
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    ensureWeekData(wk);
    const start = getWeekStart(state.weekOffset);
    // try from today forward
    for(let i=0;i<7;i++){
      const d = new Date(start); d.setDate(d.getDate()+i);
      const dayKey = formatDate(d);
      for(const meal of MEALS){
        if(!state.settings.show[meal]) continue;
        if(!state.planner[wk][dayKey][meal]){
          state.planner[wk][dayKey][meal] = { type:'recipe', id: recipeId };
          storage.set('planner', state.planner);
          renderPlanner();
          toast('A√±adido a la semana');
          return;
        }
      }
    }
    toast('No hay huecos libres');
  }

  /* ------------------------------ Share recipe ----------------------------- */
  function shareRecipe(r){
    const minimal = { id: r.id, name: r.name, desc: r.desc, ingredients: r.ingredients, photo: r.photo };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(minimal))));
    const url = `${location.origin}${location.pathname}?importRecipe=${payload}`;
    navigator.clipboard?.writeText(url);
    toast('Enlace copiado al portapapeles');
  }
  function checkImportFromURL(){
    const params = new URLSearchParams(location.search);
    const imp = params.get('importRecipe');
    if(imp){
      try{
        const obj = JSON.parse(decodeURIComponent(escape(atob(imp))));
        // if id exists, replace name to avoid conflicts? Keep existing id but ensure uniqueness
        if(!obj.id || state.recipes.some(x=>x.id===obj.id)) obj.id = uid();
        state.recipes.unshift({ id: obj.id, name: obj.name||'Receta importada', desc: obj.desc||'', ingredients: obj.ingredients||[], photo: obj.photo||'' });
        storage.set('recipes', state.recipes);
        history.replaceState({}, document.title, location.pathname); // cleanup URL
        toast('Receta importada ‚úì');
      }catch{
        toast('No se pudo importar la receta');
      }
    }
  }

  /* ---------------------------- Shopping (To-do) --------------------------- */
  $('#btnShopping').addEventListener('click', ()=>{ openShopping(); openModal('shoppingDialog'); });
  function openShopping(){
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    const list = state.shopping[wk] || [];
    renderTodo(list);
  }
  function renderTodo(items){
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    state.shopping[wk] = items;
    storage.set('shopping', state.shopping);
    const wrap = $('#todoList'); wrap.innerHTML='';
    items.forEach((it, idx)=>{
      const row = document.createElement('div'); row.className='todo-item';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.done; cb.style.accentColor='var(--primary)';
      cb.addEventListener('change', ()=>{ it.done = cb.checked; renderTodo(items); });
      const input = document.createElement('input'); input.type='text'; input.value=it.text||''; input.placeholder='Art√≠culo';
      input.addEventListener('input', ()=>{ it.text = input.value; storage.set('shopping', state.shopping); });
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Eliminar';
      del.addEventListener('click', ()=>{ items.splice(idx,1); renderTodo(items); });
      row.append(cb, input, del);
      wrap.appendChild(row);
    });
  }
  $('#addItemBtn').addEventListener('click', ()=>{
    const v = $('#newItemInput').value.trim(); if(!v) return;
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    state.shopping[wk] = state.shopping[wk] || [];
    state.shopping[wk].push({ text:v, done:false });
    $('#newItemInput').value='';
    renderTodo(state.shopping[wk]);
  });
  $('#regenFromMealsBtn').addEventListener('click', ()=>{
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    ensureWeekData(wk);
    // Gather ingredients from week
    const set = new Map();
    for(const dayKey of Object.keys(state.planner[wk])){
      for(const meal of MEALS){
        if(!state.settings.show[meal]) continue;
        const entry = state.planner[wk][dayKey][meal];
        const list = entry ? ingredientsOf(entry) : [];
        for(const ing of list){
          const key = ing.toLowerCase();
          set.set(key, ing);
        }
      }
    }
    const items = Array.from(set.values()).map(t=>({ text:t, done:false }));
    state.shopping[wk] = items;
    renderTodo(items);
    toast('Lista generada');
  });
  $('#clearDoneBtn').addEventListener('click', ()=>{
    const wk = weekKeyOf(getWeekStart(state.weekOffset));
    const items = (state.shopping[wk]||[]).filter(it=>!it.done);
    renderTodo(items);
  });
  function ingredientsOf(entry){
    if(entry.type==='manual') return entry.ingredients || [];
    if(entry.type==='recipe'){
      const r = state.recipes.find(x=>x.id===entry.id);
      return r ? (r.ingredients||[]) : [];
    }
    return [];
  }

  /* -------------------------------- Settings ------------------------------- */
  $('#toggleDark').addEventListener('change', (e)=>{
    state.settings.dark = !!e.target.checked;
    storage.set('settings', state.settings);
    applySettings();
  });
  $('#colorPicker').addEventListener('input', (e)=>{
    state.settings.primary = e.target.value;
    storage.set('settings', state.settings);
    applySettings();
  });
  $('#showBreakfast').addEventListener('change', (e)=> toggleMeal('breakfast', e.target.checked));
  $('#showLunch').addEventListener('change', (e)=> toggleMeal('lunch', e.target.checked));
  $('#showDinner').addEventListener('change', (e)=> toggleMeal('dinner', e.target.checked));
  function toggleMeal(meal, val){
    state.settings.show[meal]=!!val;
    storage.set('settings', state.settings);
    renderPlanner();
  }
  $('#btnPro').addEventListener('click', ()=> toast('Pr√≥ximamente ‚Ä¢ Gesti√≥n Pro'));

  /* --------------------------------- Modals -------------------------------- */
  function openModal(id){ const d = document.getElementById(id); if(!d.open) d.showModal(); }
  function closeModal(id){ const d = document.getElementById(id); if(d.open) d.close(); }
  $$('button[data-close]').forEach(b=>{
    b.addEventListener('click', ()=> closeModal(b.getAttribute('data-close')));
  });

  /* ---------------------------------- Toast -------------------------------- */
  let toastTimer;
  function toast(msg){
    const t = $('#toast');
    t.textContent = msg;
    if(!t.open) t.show();
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.close(), 1600);
  }

  /* ----------------------------- Placeholders ------------------------------ */
  function placeholderFor(name){
    // minimalistic SVG placeholder data URL
    const bg = encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--primary-weak').trim());
    const fg = encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--primary').trim());
    const text = encodeURIComponent((name||'R').slice(0,1).toUpperCase());
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
      <rect width='100%' height='100%' fill='${bg}'/>
      <circle cx='300' cy='200' r='120' fill='${fg}' opacity='.25'/>
      <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-size='140' font-family='sans-serif' fill='${fg}'>${text}</text>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + svg;
  }

  /* --------------------------------- Startup ------------------------------- */
  applySettings();
  renderPlanner();
  renderRecipes();
  checkImportFromURL();

  // Picker live update after open
  $('#pickerDialog').addEventListener('close', ()=> $('#pickerSearch').value='');

  // Keyboard UX niceties
  $('#newItemInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addItemBtn').click(); }});
})();
</script>
</body>
              </html>
